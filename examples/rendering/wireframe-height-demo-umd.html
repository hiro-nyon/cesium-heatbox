<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Wireframe & Height Demo - UMDç‰ˆï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ç›´æ¥å®Ÿè¡Œå¯¾å¿œï¼‰</title>
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  <script>
    window.CESIUM_BASE_URL = 'https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/';
    if (typeof Cesium !== 'undefined' && Cesium.Ion) {
      Cesium.Ion.defaultAccessToken = null;
    }
  </script>
  <style>
    html, body, #cesiumContainer { width: 100%; height: 100%; margin: 0; padding: 0; overflow: hidden; background: #000; }
    .demo-panel { position: absolute; top: 10px; left: 10px; background: rgba(40, 40, 40, 0.9); padding: 20px; border-radius: 8px; color: white; font-family: sans-serif; max-width: 380px; }
    .demo-panel h2 { margin: 0 0 15px; color: #4fc3f7; }
    .demo-section { margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #555; }
    .demo-section:last-child { border-bottom: none; }
    .demo-section h3 { margin: 0 0 10px; font-size: 16px; }
    .control-group { margin-bottom: 12px; }
    .control-group button { width: 100%; padding: 10px; margin-bottom: 8px; border: none; border-radius: 4px; cursor: pointer; font-weight: bold; }
    .control-group button:hover { opacity: 0.8; }
    .btn-traditional { background: #ff5722; color: white; }
    .btn-wireframe { background: #2196f3; color: white; }
    .btn-height { background: #4caf50; color: white; }
    .btn-combined { background: #9c27b0; color: white; }
    .btn-clear { background: #f44336; color: white; }
    .btn-demo { background: #ff9800; color: white; }
    #status { margin-top: 15px; font-weight: bold; padding: 10px; border-radius: 4px; background: rgba(0,0,0,0.3); }
    .success { color: #4caf50; }
    .error { color: #f44336; }
    .info { color: #2196f3; }
  </style>
</head>
<body>
  <div id="cesiumContainer"></div>
  <div class="demo-panel">
    <h2>ğŸ”¥ Wireframe & Height ãƒ‡ãƒ¢</h2>
    <p style="font-size: 14px; margin-bottom: 20px; color: #ccc;">
      v0.1.2æ–°æ©Ÿèƒ½ã®wireframeOnlyãƒ»heightBasedè¡¨ç¾ã‚’ä½“é¨“ã§ãã¾ã™
    </p>
    
    <div class="demo-section">
      <h3>ğŸ“Š è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰æ¯”è¼ƒ</h3>
      <div class="control-group">
        <button id="traditionalBtn" class="btn-traditional">å¾“æ¥è¡¨ç¤º (å¡—ã‚Šã¤ã¶ã—)</button>
        <button id="wireframeBtn" class="btn-wireframe">Wireframeè¡¨ç¤º (æ ç·šã®ã¿)</button>
        <button id="heightBasedBtn" class="btn-height">Height-Based (é«˜ã•ãƒ™ãƒ¼ã‚¹)</button>
        <button id="combinedBtn" class="btn-combined">Combined (æ ç·š+é«˜ã•)</button>
      </div>
    </div>
    
    <div class="demo-section">
      <h3>ğŸ® ãƒ‡ãƒ¢åˆ¶å¾¡</h3>
      <div class="control-group">
        <button id="autoCompareBtn" class="btn-demo">è‡ªå‹•æ¯”è¼ƒãƒ‡ãƒ¢é–‹å§‹</button>
        <button id="clearAllBtn" class="btn-clear">ã™ã¹ã¦ã‚¯ãƒªã‚¢</button>
      </div>
    </div>
    
    <div id="status" class="info">Ready - ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãƒ‡ãƒ¢ã‚’é–‹å§‹</div>
  </div>

  <!-- CesiumJS Heatbox UMD Build -->
  <script src="../../dist/cesium-heatbox.umd.min.js"></script>
  <script>
    // UMDãƒ“ãƒ«ãƒ‰ã‹ã‚‰CesiumHeatboxã‚’å–å¾— / Use Heatbox from UMD bundle
    const Heatbox = window.CesiumHeatbox || window.Heatbox;
    const SHINJUKU_CENTER = { lon: 139.6917, lat: 35.6895 }; // æ–°å®¿é§…ä¸­å¿ƒ / Shinjuku station center

    // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³çŠ¶æ…‹
    let viewer;
    let testEntities = [];
    let activeHeatboxes = [];

    // UIè¦ç´ 
    const elements = {};

    function createImageryProvider() {
      return new Cesium.UrlTemplateImageryProvider({
        url: 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}.png',
        subdomains: 'abcd',
        maximumLevel: 19,
        credit: 'Â© OpenStreetMap contributors Â© CARTO'
      });
    }

    function createTerrainProvider() {
      try {
        if (Cesium.Ion && Cesium.Ion.defaultAccessToken && Cesium.Ion.defaultAccessToken !== 'null') {
          return Cesium.createWorldTerrain();
        }
      } catch (error) {
        console.warn('World Terrain unavailable, using EllipsoidTerrainProvider.', error);
      }
      return new Cesium.EllipsoidTerrainProvider();
    }
    
    /**
     * ãƒ†ã‚¹ãƒˆãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆæ±äº¬é§…å‘¨è¾ºã®å¯†åº¦åˆ†å¸ƒãƒ‘ã‚¿ãƒ¼ãƒ³ï¼‰
     */
    function generateTestData() {
      const entities = [];
      const bounds = {
        minLon: SHINJUKU_CENTER.lon - 0.01,
        maxLon: SHINJUKU_CENTER.lon + 0.01,
        minLat: SHINJUKU_CENTER.lat - 0.01,
        maxLat: SHINJUKU_CENTER.lat + 0.01,
        minAlt: 0,
        maxAlt: 180
      };
      
      // æ–°å®¿å‘¨è¾ºã«é«˜å¯†åº¦ã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã‚’é…ç½® / Generate dense clusters around Shinjuku
      const clusters = [
        { centerLon: SHINJUKU_CENTER.lon, centerLat: SHINJUKU_CENTER.lat, density: 800 },
        { centerLon: SHINJUKU_CENTER.lon + 0.002, centerLat: SHINJUKU_CENTER.lat - 0.0015, density: 600 },
        { centerLon: SHINJUKU_CENTER.lon - 0.0025, centerLat: SHINJUKU_CENTER.lat + 0.001, density: 400 }
      ];
      
      clusters.forEach((cluster, clusterIndex) => {
        for (let i = 0; i < cluster.density; i++) {
          // ã‚¬ã‚¦ã‚¹åˆ†å¸ƒã£ã½ã„é…ç½®
          const angle = Math.random() * 2 * Math.PI;
          const distance = Math.sqrt(-2 * Math.log(Math.random())) * 0.0015;
          
          const lon = Cesium.Math.clamp(cluster.centerLon + Math.cos(angle) * distance, bounds.minLon, bounds.maxLon);
          const lat = Cesium.Math.clamp(cluster.centerLat + Math.sin(angle) * distance, bounds.minLat, bounds.maxLat);
          const alt = Math.random() * bounds.maxAlt;
          
          const entity = viewer.entities.add({
            position: Cesium.Cartesian3.fromDegrees(lon, lat, alt),
            point: {
              pixelSize: 3,
              color: clusterIndex === 0 ? Cesium.Color.RED.withAlpha(0.7) :
                     clusterIndex === 1 ? Cesium.Color.BLUE.withAlpha(0.7) :
                     Cesium.Color.GREEN.withAlpha(0.7),
              heightReference: Cesium.HeightReference.NONE
            },
            properties: {
              cluster: clusterIndex,
              value: Math.random() * 100
            }
          });
          entities.push(entity);
        }
      });
      
      updateStatus(`${entities.length}å€‹ã®ãƒ†ã‚¹ãƒˆã‚¨ãƒ³ãƒ†ã‚£ãƒ†ã‚£ã‚’ç”Ÿæˆ`, 'success');
      return entities;
    }
    
    /**
     * å¾“æ¥è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
     */
    async function createTraditionalDisplay() {
      clearAll();
      if (testEntities.length === 0) testEntities = generateTestData();
      
      updateStatus('å¾“æ¥è¡¨ç¤ºï¼ˆå¡—ã‚Šã¤ã¶ã—ï¼‰ã‚’ä½œæˆä¸­...', 'info');
      
      const heatbox = new Heatbox(viewer, {
        voxelSize: 25,
        opacity: 0.6,
        showOutline: true,
        wireframeOnly: false,
        heightBased: false,
        debug: false
      });
      
      await heatbox.createFromEntities(testEntities);
      activeHeatboxes.push(heatbox);
      updateStatus('å¾“æ¥è¡¨ç¤ºãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
    }
    
    /**
     * Wireframeè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
     */
    async function createWireframeDisplay() {
      clearAll();
      if (testEntities.length === 0) testEntities = generateTestData();
      
      updateStatus('Wireframeè¡¨ç¤ºï¼ˆæ ç·šã®ã¿ï¼‰ã‚’ä½œæˆä¸­...', 'info');
      
      const heatbox = new Heatbox(viewer, {
        voxelSize: 25,
        wireframeOnly: true,
        showOutline: true,
        outlineWidth: 2,
        heightBased: false,
        debug: false
      });
      
      await heatbox.createFromEntities(testEntities);
      activeHeatboxes.push(heatbox);
      updateStatus('Wireframeè¡¨ç¤ºãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
    }
    
    /**
     * Height-Basedè¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
     */
    async function createHeightBasedDisplay() {
      clearAll();
      if (testEntities.length === 0) testEntities = generateTestData();
      
      updateStatus('Height-Basedè¡¨ç¤ºï¼ˆé«˜ã•ãƒ™ãƒ¼ã‚¹ï¼‰ã‚’ä½œæˆä¸­...', 'info');
      
      const heatbox = new Heatbox(viewer, {
        voxelSize: 25,
        opacity: 0.8,
        wireframeOnly: false,
        heightBased: true,
        showOutline: false,
        debug: false
      });
      
      await heatbox.createFromEntities(testEntities);
      activeHeatboxes.push(heatbox);
      updateStatus('Height-Basedè¡¨ç¤ºãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
    }
    
    /**
     * çµ„ã¿åˆã‚ã›è¡¨ç¤ºãƒ¢ãƒ¼ãƒ‰
     */
    async function createCombinedDisplay() {
      clearAll();
      if (testEntities.length === 0) testEntities = generateTestData();
      
      updateStatus('Combinedè¡¨ç¤ºï¼ˆæ ç·š+é«˜ã•ï¼‰ã‚’ä½œæˆä¸­...', 'info');
      
      const heatbox = new Heatbox(viewer, {
        voxelSize: 25,
        opacity: 0.4,
        wireframeOnly: true,
        heightBased: true,
        showOutline: true,
        outlineWidth: 3,
        debug: false
      });
      
      await heatbox.createFromEntities(testEntities);
      activeHeatboxes.push(heatbox);
      updateStatus('Combinedè¡¨ç¤ºãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
    }
    
    /**
     * è‡ªå‹•æ¯”è¼ƒãƒ‡ãƒ¢
     */
    async function runAutoCompareDemo() {
      updateStatus('è‡ªå‹•æ¯”è¼ƒãƒ‡ãƒ¢ã‚’é–‹å§‹ã—ã¾ã™...', 'info');
      
      const modes = [
        { name: 'å¾“æ¥è¡¨ç¤º', fn: createTraditionalDisplay },
        { name: 'Wireframeè¡¨ç¤º', fn: createWireframeDisplay },
        { name: 'Height-Basedè¡¨ç¤º', fn: createHeightBasedDisplay },
        { name: 'Combinedè¡¨ç¤º', fn: createCombinedDisplay }
      ];
      
      for (const mode of modes) {
        updateStatus(`${mode.name}ã‚’è¡¨ç¤ºä¸­...`, 'info');
        await mode.fn();
        await delay(3000); // 3ç§’é–“è¡¨ç¤º
      }
      
      updateStatus('è‡ªå‹•æ¯”è¼ƒãƒ‡ãƒ¢ãŒå®Œäº†ã—ã¾ã—ãŸ', 'success');
    }
    
    /**
     * ã™ã¹ã¦ã‚¯ãƒªã‚¢
     */
    function clearAll() {
      activeHeatboxes.forEach(heatbox => heatbox.clear());
      activeHeatboxes = [];
      viewer.entities.removeAll();
      testEntities = [];
    }
    
    /**
     * ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹æ›´æ–°
     */
    function updateStatus(message, type = 'info') {
      const statusEl = elements.status;
      statusEl.textContent = message;
      statusEl.className = type;
      console.log(`[${type.toUpperCase()}] ${message}`);
    }
    
    /**
     * é…å»¶ãƒ˜ãƒ«ãƒ‘ãƒ¼
     */
    function delay(ms) {
      return new Promise(resolve => setTimeout(resolve, ms));
    }
    
    /**
     * ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆæœŸåŒ–
     */
    async function initializeApp() {
      try {
        // CesiumJS VieweråˆæœŸåŒ– / Initialize viewer with Carto imagery
        const imageryProvider = createImageryProvider();
        viewer = new Cesium.Viewer('cesiumContainer', {
          imageryProvider,
          terrainProvider: createTerrainProvider(),
          homeButton: false,
          sceneModePicker: false,
          baseLayerPicker: false,
          navigationHelpButton: false,
          animation: false,
          timeline: false,
          fullscreenButton: false,
          geocoder: false,
          infoBox: true,
          selectionIndicator: true,
          creditContainer: document.createElement('div')
        });
        viewer.imageryLayers.removeAll();
        viewer.imageryLayers.addImageryProvider(imageryProvider);
        viewer.scene.globe.baseColor = Cesium.Color.fromCssColorString('#0f172a');
        
        // ã‚«ãƒ¡ãƒ©ã‚’æ–°å®¿é§…å‘¨è¾ºã«è¨­å®š / Focus camera on Shinjuku
        viewer.camera.setView({
          destination: Cesium.Cartesian3.fromDegrees(SHINJUKU_CENTER.lon, SHINJUKU_CENTER.lat, 1000),
          orientation: {
            heading: Cesium.Math.toRadians(0),
            pitch: Cesium.Math.toRadians(-45),
            roll: 0
          }
        });
        
        // UIè¦ç´ å–å¾—
        const uiIds = ['traditionalBtn', 'wireframeBtn', 'heightBasedBtn', 'combinedBtn', 'autoCompareBtn', 'clearAllBtn', 'status'];
        uiIds.forEach(id => elements[id] = document.getElementById(id));
        
        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        elements.traditionalBtn.addEventListener('click', createTraditionalDisplay);
        elements.wireframeBtn.addEventListener('click', createWireframeDisplay);
        elements.heightBasedBtn.addEventListener('click', createHeightBasedDisplay);
        elements.combinedBtn.addEventListener('click', createCombinedDisplay);
        elements.autoCompareBtn.addEventListener('click', runAutoCompareDemo);
        elements.clearAllBtn.addEventListener('click', clearAll);
        
        updateStatus('ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãŒåˆæœŸåŒ–ã•ã‚Œã¾ã—ãŸ', 'success');
        
      } catch (error) {
        console.error('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼:', error);
        updateStatus('åˆæœŸåŒ–ã‚¨ãƒ©ãƒ¼: ' + error.message, 'error');
      }
    }
    
    // DOMèª­ã¿è¾¼ã¿å®Œäº†å¾Œã«åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', initializeApp);
  </script>
</body>
</html>
