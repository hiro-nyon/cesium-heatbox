<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#0e1b22">
  <title>Cesium Heatbox Playground</title>
  <!-- Favicon を追加してエラーを防ぐ -->
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>🌍</text></svg>">
  <!-- CesiumJS CDN - バージョン 1.120 -->
  <script src="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Cesium.js"></script>
  <link href="https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
  
  <!-- Playground styles -->
  <link href="styles.css" rel="stylesheet">
  
  <!-- Cesium settings (no Ion token; CartoDB Light imagery set in app.js) -->
  <script>
    window.CESIUM_BASE_URL = 'https://cesium.com/downloads/cesiumjs/releases/1.120/Build/Cesium/';
    if (typeof Cesium !== 'undefined' && Cesium.Ion) {
      Cesium.Ion.defaultAccessToken = null; // 明示的にIonを無効化
    }
  </script>
</head>
<body>
  <div id="cesiumContainer"></div>
  
  <!-- モバイル向けハンバーガーメニューボタン -->
  <button id="mobileMenuToggle" aria-label="メニューを開く">☰</button>
  
  <div id="toolbar">
    <div class="section">
      <h3 id="i18n-title">🎛️ Cesium Heatbox Playground</h3>
      <p style="font-size: 11px; margin: 5px 0;" data-i18n="subtitle">v0.1.9 新機能対応版</p>
      <div class="control-group">
        <label id="i18n-lang-label" for="langSelect">言語</label>
        <select id="langSelect">
          <option value="ja">日本語</option>
          <option value="en">English</option>
        </select>
      </div>
    </div>
    
    <details class="section" open>
      <summary id="i18n-sum-data">📁 データ読み込み</summary>
      <div class="section-content">
        <input type="file" id="fileInput" accept=".json,.geojson,.czml" />
        <button id="loadSampleData" data-i18n="btn_load_sample">サンプルデータを読み込み</button>
        <button id="generateTestData" data-i18n="btn_generate_test">テストデータを生成</button>
      </div>
    </details>
    
    <details class="section" open>
      <summary id="i18n-sum-display">🔧 表示設定</summary>
      <div class="controls section-content">
        <div class="control-group">
          <label data-i18n="label_baseMap">背景地図:</label>
          <select id="baseMap">
            <option value="carto-light" selected>CartoDB Light (Positron)</option>
            <option value="carto-dark">CartoDB Dark Matter</option>
            <option value="osm-standard">OpenStreetMap Standard</option>
            <option value="osm-humanitarian">OSM Humanitarian</option>
          </select>
        </div>
        <div class="control-group">
          <label>
            <input type="checkbox" id="autoVoxelSize" />
            <span data-i18n="chk_autoVoxel">自動サイズ決定（v0.1.4新機能）</span>
          </label>
        </div>
        <div class="control-group" id="autoVoxelModeGroup" style="opacity: 0.5; pointer-events: none;">
          <label data-i18n="label_autoVoxelMode">自動サイズモード:</label>
          <select id="autoVoxelSizeMode" disabled>
            <option value="simple" data-i18n="opt_autoVoxel_simple">Simple（v0.1.8）</option>
            <option value="occupancy" data-i18n="opt_autoVoxel_occupancy">Occupancy（v0.1.9新）</option>
          </select>
        </div>
        <div class="control-group" id="manualSizeGroup">
          <label data-i18n="label_gridSize">グリッドサイズ（手動）:</label>
          <input type="range" id="gridSize" min="10" max="100" value="20" />
          <span id="gridSizeValue">20</span>
        </div>
        <div class="control-group">
          <label>
            <input type="checkbox" id="heightBased" />
            <span data-i18n="chk_heightBased">高さベース表現</span>
          </label>
        </div>
        <div class="control-group">
          <label>
            <input type="checkbox" id="showEmptyVoxels" />
            <span data-i18n="chk_showEmpty">空のボクセルを表示</span>
          </label>
        </div>
        <div class="control-group" id="emptyOpacityGroup" style="opacity: 0.5; pointer-events: none;">
          <label data-i18n="label_emptyOpacity">空ボクセル透明度:</label>
          <input type="range" id="emptyOpacity" min="0" max="1" step="0.05" value="0.1" disabled />
          <span id="emptyOpacityValue">0.1</span>
        </div>
        <div class="control-group">
          <label>
            <input type="checkbox" id="wireframeOnly" />
            <span data-i18n="chk_wireframeOnly">枠線のみ表示</span>
          </label>
        </div>
      </div>
    </details>

    <details class="section">
      <summary id="i18n-sum-color">🎨 色設定</summary>
      <div class="controls section-content">
        <div class="control-group">
          <label data-i18n="label_colorMap">カラーマップ:</label>
          <select id="colorMap">
            <option value="custom" data-i18n="opt_color_custom">カスタム（従来）</option>
            <option value="viridis" selected data-i18n="opt_color_viridis">Viridis（科学的）</option>
            <option value="inferno" data-i18n="opt_color_inferno">Inferno（科学的）</option>
          </select>
        </div>
        <div class="control-group" id="customColorGroup">
          <label data-i18n="label_customColor">カスタム色:</label>
          <select id="customColorTheme">
            <option value="heat" data-i18n="opt_theme_heat">ヒート（青→赤）</option>
            <option value="cool" data-i18n="opt_theme_cool">クール（青→マゼンタ）</option>
            <option value="rainbow" data-i18n="opt_theme_rainbow">レインボー</option>
          </select>
        </div>
        <div class="control-group">
          <label>
            <input type="checkbox" id="diverging" />
            <span data-i18n="chk_diverging">二極性データ（blue-white-red）</span>
          </label>
        </div>
        <div class="control-group" id="divergingPivotGroup" style="opacity: 0.5; pointer-events: none;">
          <label data-i18n="label_divergingPivot">二極性中心値:</label>
          <input type="number" id="divergingPivot" value="0" step="0.1" disabled />
        </div>
      </div>
    </details>

    <details class="section">
      <summary id="i18n-sum-outline">✏️ 枠線・見た目</summary>
      <div class="controls section-content">
        <div class="control-group">
          <label data-i18n="label_outlineRenderMode">描画モード:</label>
          <select id="outlineRenderMode">
            <option value="standard" selected data-i18n="opt_render_standard">標準</option>
            <option value="inset" data-i18n="opt_render_inset">インセット主体</option>
            <option value="emulation-only" data-i18n="opt_render_emulation">エミュレーションのみ</option>
          </select>
        </div>
        <!-- v0.1.6.1: インセット枠線（ADR-0004） -->
        <div class="control-group">
          <label data-i18n="label_outlineInset">インセット枠線 (m):</label>
          <input type="range" id="outlineInset" min="0" max="20" step="0.5" value="0" />
          <span id="outlineInsetValue">0.0</span>
        </div>
        <div class="control-group">
          <label data-i18n="label_outlineInsetMode">インセット適用範囲:</label>
          <select id="outlineInsetMode">
            <option value="off" data-i18n="opt_inset_off">OFF（無効）</option>
            <option value="topn" data-i18n="opt_inset_topn">TopN のみ</option>
            <option value="all" selected data-i18n="opt_inset_all">全体</option>
          </select>
        </div>
        <div class="control-group">
          <label>
            <input type="checkbox" id="enableThickFrames" />
            <span data-i18n="chk_thickFrames">厚い枠線表示（フレーム埋め込み）</span>
          </label>
        </div>
        <!-- v0.1.6: 枠線重なり対策（ボクセル間ギャップ） -->
        <div class="control-group">
          <label data-i18n="label_voxelGap">ボクセル間ギャップ (m):</label>
          <input type="range" id="voxelGap" min="0" max="20" step="0.5" value="0" />
          <span id="voxelGapValue">0.0</span>
        </div>
        <!-- v0.1.6: 枠線透明度制御 -->
        <div class="control-group">
          <label data-i18n="label_outlineOpacity">枠線透明度:</label>
          <input type="range" id="outlineOpacity" min="0" max="1" step="0.1" value="1" />
          <span id="outlineOpacityValue">1.0</span>
        </div>
        <!-- v0.1.6: 枠線太さモード -->
        <div class="control-group">
          <label data-i18n="label_outlineMode">枠線太さモード:</label>
          <select id="outlineMode">
            <option value="adaptive" selected data-i18n="opt_outline_adaptive">自動（密度に応じて調整）</option>
            <option value="manual" data-i18n="opt_outline_manual">手動（固定太さ）</option>
          </select>
        </div>
        <div class="control-group" id="manualOutlineWidthGroup" style="opacity: 0.5; pointer-events: none;">
          <label data-i18n="label_outlineWidth">枠線太さ (px):</label>
          <input type="range" id="outlineWidth" min="0" max="8" step="1" value="2" disabled />
          <span id="outlineWidthValue">2</span>
        </div>
        <div class="control-group">
          <label data-i18n="label_outlineEmulation">太線エミュレーション:</label>
          <select id="outlineEmulationMode">
            <option value="off" data-i18n="opt_emul_off">無効</option>
            <option value="topn" data-i18n="opt_emul_topn">TopNのみ</option>
            <option value="non-topn" data-i18n="opt_emul_non_topn">TopN以外のみ</option>
            <option value="all" data-i18n="opt_emul_all">すべて太線（自動インセット適用）</option>
          </select>
        </div>
      </div>
    </details>

    <details class="section">
      <summary id="i18n-sum-adaptive">⚙️ 適応表示（v0.1.9新機能）</summary>
      <div class="controls section-content">
        <div class="control-group">
          <label data-i18n="label_maxRenderVoxels">最大レンダーボクセル数:</label>
          <select id="maxRenderVoxels">
            <option value="auto" selected data-i18n="opt_budget_auto">Auto Budget（自動）</option>
            <option value="3000" data-i18n="opt_budget_3k">3,000（軽量）</option>
            <option value="8000" data-i18n="opt_budget_8k">8,000（標準）</option>
            <option value="15000" data-i18n="opt_budget_15k">15,000（高性能）</option>
            <option value="50000" data-i18n="opt_budget_50k">50,000（最大）</option>
          </select>
        </div>
        <div class="control-group">
          <label data-i18n="label_renderStrategy">レンダリング戦略:</label>
          <select id="renderLimitStrategy">
            <option value="density" data-i18n="opt_strategy_density">Density（密度重視）</option>
            <option value="coverage" data-i18n="opt_strategy_coverage">Coverage（範囲重視）</option>
            <option value="hybrid" selected data-i18n="opt_strategy_hybrid">Hybrid（バランス）</option>
          </select>
        </div>
        <div class="control-group">
          <label>
            <input type="checkbox" id="autoView" />
            <span data-i18n="chk_autoView">自動カメラ位置調整</span>
          </label>
        </div>
        <div class="control-group" id="fitViewGroup" style="opacity: 0.5; pointer-events: none;">
          <label data-i18n="label_fitViewHeading">カメラ方向（度）:</label>
          <input type="range" id="fitViewHeading" min="0" max="360" step="15" value="0" disabled />
          <span id="fitViewHeadingValue">0</span>
        </div>
        <div class="control-group" id="fitViewPitchGroup" style="opacity: 0.5; pointer-events: none;">
          <label data-i18n="label_fitViewPitch">カメラ角度（度）:</label>
          <input type="range" id="fitViewPitch" min="-90" max="0" step="5" value="-45" disabled />
          <span id="fitViewPitchValue">-45</span>
        </div>
        <button id="manualFitView" data-i18n="btn_fitView">手動カメラフィット</button>
      </div>
    </details>

    <details class="section">
      <summary id="i18n-sum-legacy-adaptive">⚙️ 適応表示（レガシー）</summary>
      <div class="controls section-content">
        <div class="control-group">
          <label>
            <input type="checkbox" id="adaptiveOutlines" />
            <span data-i18n="chk_adaptiveOutlines">適応的枠線制御を有効化</span>
          </label>
        </div>
        <div class="control-group">
          <label data-i18n="label_outlinePreset">枠線プリセット:</label>
          <select id="outlineWidthPreset">
            <option value="uniform" selected data-i18n="opt_preset_uniform">均一</option>
            <option value="adaptive-density" data-i18n="opt_preset_density">密度適応</option>
            <option value="topn-focus" data-i18n="opt_preset_topn">TopN重視</option>
          </select>
        </div>
        <div class="control-group">
          <label data-i18n="label_boxOpacityMode">ボックス透明度:</label>
          <select id="boxOpacityMode">
            <option value="off" selected data-i18n="opt_opacity_off">固定（従来）</option>
            <option value="density" data-i18n="opt_opacity_density">密度ベース</option>
            <option value="topn" data-i18n="opt_opacity_topn">TopNベース</option>
          </select>
        </div>
        <div class="control-group">
          <label data-i18n="label_outlineOpacityMode">枠線透明度:</label>
          <select id="outlineOpacityMode">
            <option value="off" selected data-i18n="opt_opacity_off">固定（従来）</option>
            <option value="density" data-i18n="opt_opacity_density">密度ベース</option>
            <option value="topn" data-i18n="opt_opacity_topn">TopNベース</option>
          </select>
        </div>
      </div>
    </details>

    <details class="section">
      <summary id="i18n-sum-highlight">⭐ 強調表示</summary>
      <div class="controls section-content">
        <div class="control-group">
          <label data-i18n="label_highlightTopN">TopN強調表示:</label>
          <input type="number" id="highlightTopN" min="0" max="50" value="0" placeholder="0=無効" data-i18n-placeholder="ph_highlightTopN" />
        </div>
        <div class="control-group" id="highlightStyleGroup" style="opacity: 0.5; pointer-events: none;">
          <label data-i18n="label_highlightOpacity">非TopNの減衰量:</label>
          <input type="range" id="highlightOpacity" min="0.1" max="1" step="0.1" value="0.9" disabled />
          <span id="highlightOpacityValue">0.9</span>
        </div>
      </div>
    </details>

    <details class="section">
      <summary id="i18n-sum-advanced">🛠️ 詳細設定</summary>
      <div class="controls section-content">
        <div class="control-group">
          <label>
            <input type="checkbox" id="debugMode" />
            <span data-i18n="chk_debugMode">デバッグモード（ログ出力）</span>
          </label>
        </div>
        <div class="control-group">
          <label>
            <input type="checkbox" id="showBounds" />
            <span data-i18n="chk_showBounds">境界ボックス表示</span>
          </label>
        </div>
        <button id="testHeatbox" style="background-color: orange;" data-i18n="btn_testHeatbox">Heatboxテスト</button>
      </div>
    </details>
    
    <div class="section">
      <h3 id="i18n-ops-title">🎮 操作</h3>
      <button id="createHeatmap" data-i18n="btn_create">ヒートマップ作成</button>
      <button id="clearHeatmap" data-i18n="btn_clear">クリア</button>
      <button id="toggleVisibility" data-i18n="btn_toggle">表示/非表示</button>
      <button id="exportData" data-i18n="btn_export">データ出力</button>
    </div>
  </div>
  
  <div id="info">
    <div class="section">
      <h3 id="i18n-stats-title">📊 統計情報</h3>
      <div id="statistics">
        <p><span id="i18n-label-dataCount">データ点数:</span> <span id="dataCount">0</span></p>
        <p><span id="i18n-label-voxelCount">ボクセル数:</span> <span id="voxelCount">0</span></p>
        <p><span id="i18n-label-emptyVoxel">空ボクセル:</span> <span id="emptyVoxelCount">0</span></p>
        <p><span id="i18n-label-max">最大値:</span> <span id="maxValue">-</span></p>
        <p><span id="i18n-label-min">最小値:</span> <span id="minValue">-</span></p>
        <p><span id="i18n-label-avg">平均値:</span> <span id="avgValue">-</span></p>
        <div id="autoSizeInfo" style="font-size: 10px; color: #aaa; margin-top: 5px; display: none;">
          <p><span id="i18n-autosize-adjusted">自動調整:</span> <span id="autoAdjusted">-</span></p>
          <p><span id="i18n-autosize-size">サイズ:</span> <span id="sizeInfo">-</span></p>
        </div>
        <div id="v019Stats" style="font-size: 10px; color: #4CAF50; margin-top: 5px; display: none;">
          <p><span id="i18n-v019-strategy">戦略:</span> <span id="selectionStrategy">-</span></p>
          <p><span id="i18n-v019-rendered">レンダー数:</span> <span id="renderedVoxels">-</span></p>
          <p><span id="i18n-v019-tier">デバイス:</span> <span id="deviceTier">-</span></p>
          <p><span id="i18n-v019-coverage">カバレッジ:</span> <span id="coverageRatio">-</span>%</p>
        </div>
      </div>
    </div>
    
    <div class="section">
      <h3 id="i18n-env-title">🔍 環境情報</h3>
      <div id="environmentInfo">
        <p><span id="i18n-label-cesium">Cesium:</span> <span id="cesiumVersion">-</span></p>
        <p><span id="i18n-label-heatbox">Heatbox:</span> <span id="heatboxVersion">-</span></p>
        <p><span id="i18n-label-webgl">WebGL:</span> <span id="webglSupport">-</span></p>
      </div>
    </div>

    <div class="section">
      <h3 id="i18n-or-title">🧪 Outline Resolver 統計</h3>
      <div id="outlineStats" style="font-size: 12px;">
        <p><span id="i18n-label-or-calls">呼び出し回数:</span> <span id="or_calls">0</span></p>
        <p><span id="i18n-label-or-avg">平均太さ:</span> <span id="or_avg">-</span> px</p>
        <p><span id="i18n-label-or-minmax">太さ min/max:</span> <span id="or_min">-</span> / <span id="or_max">-</span> px</p>
        <p><span id="i18n-label-or-dminmax">密度 min/max:</span> <span id="or_dmin">-</span> / <span id="or_dmax">-</span></p>
        <p><span id="i18n-label-or-topn">TopN対象:</span> <span id="or_topn">0</span></p>
      </div>
    </div>
  </div>
  
  <div id="loading">
    <p data-i18n="loading">処理中...</p>
  </div>
  
  <!-- Heatbox ライブラリ -->
  <script src="../dist/cesium-heatbox.umd.min.js?v=0.1.9"></script>
  <script src="app.js"></script>
</body>
</html>
