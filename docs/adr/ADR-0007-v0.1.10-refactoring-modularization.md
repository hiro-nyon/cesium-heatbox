# ADR-0007: リファクタリング・モジュール化（v0.1.10）

## Status
Superseded by ADR-0008 - 2025-09-04 (Introduced-in: v0.1.10)

## Context
- v0.1.9 で適応的レンダリング制限とスマート視覚化支援が完了し、機能的要件は満たされた
- 現在の `VoxelRenderer.js` が約1,265行の大きなファイルとなり、複数の責務が混在している：
  - ボクセル選択戦略（density/coverage/hybrid）のロジック
  - 自動ボクセルサイズ推定（basic/occupancy）の計算
  - 端末ティア検出（Auto Render Budget）の処理
  - 視点調整（fitView）の実装
  - 実際の描画処理
- 保守性とテスタビリティの観点から、単一責任原則に従った分離が必要
- しかし、公開APIの後方互換性は絶対に維持する必要がある
- 外部から見た挙動は一切変更せず、内部構造のみを整理する

### 課題
1. **可読性の低下**: 1つのクラスに多くの機能が集約され、理解が困難
2. **テストの困難さ**: 各機能の単体テストが複雑化
3. **拡張性の制限**: 新しい選択戦略や推定アルゴリズムの追加が困難
4. **責務の混在**: 描画処理と選択ロジックが同一クラス内に存在

### 目標
- ファイルあたりの行数を200-350行に収める
- 各モジュールの責務を明確化
- 単体テストの容易性向上
- 将来の機能拡張への準備

## Decision

### 1) モジュール分離設計

#### 1.1 選択戦略の分離
- 新設ディレクトリ: `src/core/selection/`
- 戦略インターフェースの統一化とコンクリート実装の分離

**ファイル構成:**
```
src/core/selection/
├── SelectionStrategyInterface.js  # 戦略の共通インターフェース
├── DensitySelectionStrategy.js    # 密度優先選択
├── CoverageSelectionStrategy.js   # カバレッジ選択（層化抽出）
└── HybridSelectionStrategy.js     # ハイブリッド選択
```

**インターフェース仕様:**
```javascript
class SelectionStrategyInterface {
  /**
   * Select voxels according to strategy
   * @param {Array} allVoxels - All available voxels
   * @param {number} maxCount - Maximum selection count
   * @param {Object} grid - Grid information
   * @param {Set} forceInclude - Voxels to force include
   * @param {Object} options - Strategy-specific options
   * @returns {Object} { selected: Array, metadata: Object }
   */
  select(allVoxels, maxCount, grid, forceInclude, options) {
    throw new Error('Must implement select method');
  }
}
```

#### 1.2 推定/計算機能の分離
- 新設ファイル: `src/utils/voxelSizeEstimator.js`
- 基本推定（basic）と占有率ベース推定（occupancy）を独立化

**API仕様:**
```javascript
export class VoxelSizeEstimator {
  /**
   * Estimate optimal voxel size
   * @param {Array} data - Data points
   * @param {Object} bounds - Data bounds
   * @param {string} mode - 'basic' | 'occupancy'
   * @param {Object} options - Estimation options
   * @returns {Object} { voxelSize: number, metadata: Object }
   */
  static estimate(data, bounds, mode, options) { /* ... */ }
}
```

#### 1.3 端末ティア検出の分離（現状：実装済み）
- 既に `src/utils/deviceTierDetector.js` が存在し、Auto Render Budget 計算を実装済み（v0.1.9）。
- 本リファクタでは当該モジュールの再利用とI/Fの明確化のみを行う。

**API仕様:**
```javascript
export class DeviceTierDetector {
  /**
   * Detect device performance tier
   * @returns {Object} { tier: string, maxRenderVoxels: number, metadata: Object }
   */
  static detectTier() { /* ... */ }
}
```

#### 1.4 視点調整機能の分離
- 新設ファイル: `src/utils/ViewFitter.js`
- カメラ調整ロジックの独立化とHeatboxとの連携

**API仕様:**
```javascript
export class ViewFitter {
  /**
   * Calculate optimal camera position for data bounds
   * @param {Cesium.Viewer} viewer - Cesium viewer
   * @param {Object} bounds - Data bounds
   * @param {Object} options - View options
   * @returns {Promise} Camera flyTo promise
   */
  static fitToBounds(viewer, bounds, options) { /* ... */ }
}
```

#### 1.5 オプション正規化の抽出（任意実装）
- 新設ファイル: `src/utils/options/normalizer.js`
- 複雑になったオプション検証を専用モジュールに移管

### 2) 実装フェーズ

#### Phase 1: 選択戦略の分離（Week 1）
Status: Completed

1. `SelectionStrategyInterface` の定義（実装済み: `src/core/selection/SelectionStrategyInterface.js`）
2. `DensitySelectionStrategy` の実装（実装済み: `src/core/selection/DensitySelectionStrategy.js`）
3. `VoxelRenderer` からの戦略呼び出し部分の置き換え（実装済み: `VoxelRenderer` 内で `density` 戦略を DI 済）
4. 単体テストの作成・移行（実装済み: `test/core/selection/DensitySelectionStrategy.test.js`）

#### Phase 2: 推定・検出機能の分離（Week 2）
Status: Completed

1. `VoxelSizeEstimator` の実装（実装済み: `src/utils/voxelSizeEstimator.js`）
2. `DeviceTierDetector` の実装（実装済み: `src/utils/deviceTierDetector.js`）
3. `Heatbox` クラスからの呼び出し変更（実装済み: `src/Heatbox.js` に統合）
4. 単体テストの作成（実装済み: `test/utils/VoxelSizeEstimator.test.js`, `test/utils/DeviceTierDetector.test.js`）

#### Phase 3: 残り機能の分離（Week 3）
Status: Completed

1. `CoverageSelectionStrategy` と `HybridSelectionStrategy` の実装（実装済み: `src/core/selection/CoverageSelectionStrategy.js`, `src/core/selection/HybridSelectionStrategy.js`。現状、`VoxelRenderer` では従来の内部実装も維持しており、Phase 4で切替を計画）
2. `ViewFitter` の実装（実装済み: `src/utils/ViewFitter.js`。`Heatbox.fitView` への導入はPhase 4で行う）
3. オプション正規化（必要に応じて）
4. 統合テストの確認（新規ユニットテスト追加: `test/core/selection/CoverageSelectionStrategy.test.js`, `test/core/selection/HybridSelectionStrategy.test.js`, `test/utils/ViewFitter.test.js`）

#### Phase 4: 最適化・統合（Week 4）
Status: In Progress

1. ファイル行数の確認と最適化
2. JSDoc/型注釈の整備
3. 性能テストによる回帰確認
4. ドキュメント更新

### 3) 後方互換性保証

#### 3.1 Public API の維持
- `Heatbox` クラスの全公開メソッドとオプションは変更しない
- `VoxelRenderer` の公開インターフェースは維持
- 既存の Examples/テストコードは修正なしで動作する

#### 3.2 挙動の一致
- 同一入力に対する出力結果の完全一致
- 統計情報（`getStatistics()`）の形式維持
- エラーメッセージとハンドリングの維持

#### 3.3 設定オプションの継続
- 全ての既存オプション名と値の範囲を維持
- デフォルト値の変更なし
- 非推奨警告も含めた互換性維持

### 4) 品質要件

#### 4.1 行数制限
- `VoxelRenderer.js`: 350行以下（現在約1,265行）
- 新規ファイル: 200-350行の範囲
- `Heatbox.js`: 400〜500行以下を目標（現在約665行。`fitView` 等の分離で削減）

#### 4.2 テスト要件
- 既存テストスイートの100%パス維持
- 新規モジュールごとに専用テストファイル作成
- カバレッジの向上（特に分岐テスト）

#### 4.3 性能要件
- 既存比で処理時間±5%以内の維持
- メモリ使用量の増加は10%以内
- CI/ビルド時間の顕著な増加なし

## Consequences

### Positive
- **保守性向上**: 各機能の責務が明確になり、修正が容易
- **テスト性向上**: 個別機能の単体テストが簡潔に
- **拡張性向上**: 新しい戦略やアルゴリズムの追加が容易
- **可読性向上**: ファイルサイズの縮小により理解が向上
- **並行開発**: 異なる機能の開発が独立して可能

### Negative / Risks
- **一時的複雑性**: リファクタリング中の一時的な混乱
- **インポート増加**: モジュール間の依存関係が複雑化
- **デバッグ難易度**: 機能が分散することによる追跡の困難さ
- **互換性リスク**: 意図しない挙動変更の可能性

### Mitigation Strategies
- 小さなPR単位での段階的実装
- 各段階での回帰テスト実行
- 既存Examples/テストでの動作確認
- コードレビューの徹底

## Alternatives Considered

### 1) 大規模リライト
- **検討内容**: ゼロからの完全書き直し
- **却下理由**: リスクが高く、既存互換性の保証が困難

### 2) 最小限の分離のみ
- **検討内容**: 選択戦略のみの分離
- **却下理由**: 根本的な問題解決にならない

### 3) TypeScript移行との同時実施
- **検討内容**: リファクタリングと同時にTypeScript化
- **却下理由**: 変更範囲が大きすぎ、リスクが増大

## Constraints

### 技術制約
- Node.js/ES6モジュールシステムの継続使用
- Cesium.js APIとの互換性維持
- 既存のビルドプロセス（Webpack）への影響最小化

### 互換性制約
- 既存API/オプション/挙動の完全維持
- Examples/テストコードの修正不要
- 既存プロジェクトでの置き換え可能性

### 性能制約
- 処理時間の退行許容範囲: ±5%
- メモリ使用量増加許容範囲: 10%以内
- ファイルサイズ増加許容範囲: 15%以内

## Acceptance Criteria

### 機能要件
- [ ] **完全互換性**: 既存のExamples（Basic/Advanced）が修正なしで動作
- [ ] **結果一致**: 同一入力での出力が分離前と完全一致
- [ ] **統計整合**: `getStatistics()` の返却値が既存と同一
- [ ] **エラーハンドリング**: 例外処理とメッセージが既存と同一

### 構造要件
- [ ] **ファイル分割**: `VoxelRenderer.js` が350行以下
- [x] **モジュール作成**: 計画された4つの新規モジュールが実装完了
- [ ] **依存関係**: 循環依存の回避と明確な階層構造
- [x] **インターフェース**: 戦略パターンの適切な実装

### 品質要件
- [x] **テスト保持**: 既存テストの100%パス維持
- [x] **新規テスト**: 各新規モジュールに対応するテストファイル
- [x] **Lint合格**: 全ファイルでLint errors 0
- [ ] **JSDoc整備**: 公開関数/クラスの型注釈とドキュメント

### 性能要件
- [ ] **処理時間**: 既存比±5%以内で主要操作（setData/render）が完了
- [ ] **メモリ安定**: 複数回の描画/再設定でリークなし
- [ ] **ビルド時間**: CI実行時間の顕著な増加なし（±10%以内）

## Implementation Details

### ファイル移行計画
```
現在: src/core/VoxelRenderer.js (1,111行)
↓
分離後:
- src/core/VoxelRenderer.js (300行) - 描画処理のみ
- src/core/selection/DensitySelectionStrategy.js (150行)
- src/core/selection/CoverageSelectionStrategy.js (200行)
- src/core/selection/HybridSelectionStrategy.js (180行)
- src/utils/voxelSizeEstimator.js (200行)
- src/utils/deviceTierDetector.js (150行)
- src/utils/ViewFitter.js (180行)
```

### テストファイル追加
```
- test/core/selection/DensitySelectionStrategy.test.js
- test/core/selection/CoverageSelectionStrategy.test.js
- test/core/selection/HybridSelectionStrategy.test.js
- test/utils/voxelSizeEstimator.test.js
- test/utils/deviceTierDetector.test.js
- test/utils/viewFit.test.js
```

### JSDoc/型注釈の統一化
- 全公開クラス・メソッドに統一フォーマットのJSDoc
- パラメータ・戻り値の型情報明記
- 使用例の追加（主要なpublicメソッド）

## Rollout & Migration

### Phase 1: Foundation（Week 1）
- [x] `SelectionStrategyInterface` と基底クラスの実装
- [x] `DensitySelectionStrategy` の実装・テスト
- [x] `VoxelRenderer` の戦略呼び出し部分の置き換え

### Phase 2: Core Utilities（Week 2）
- [x] `VoxelSizeEstimator` の実装・テスト
- [x] `DeviceTierDetector` の実装・テスト（実装済の検証とI/F整備）
- [x] `Heatbox` クラスの該当部分更新

### Phase 3: Advanced Strategies（Week 3）
- [x] `CoverageSelectionStrategy` の実装・テスト
- [x] `HybridSelectionStrategy` の実装・テスト
- [x] `ViewFitter` の実装・テスト

### Phase 4: Finalization（Week 4）
- [x] 全モジュールの統合テスト
- [ ] 性能・メモリテストの実行
- [ ] ドキュメント・Examples の確認
- [x] 最終的なLint・品質チェック

移行ポリシー:
- 既存コードの段階的移行（破壊的変更なし）
- 各Phase完了時点での動作確認
- CI/CDパイプラインでの自動テスト実行

## Monitoring & Validation

### 継続監視項目
- **処理時間**: 主要操作（setData/render/updateOptions）の実行時間
- **メモリ使用量**: ブラウザ上でのヒープ使用量
- **ファイルサイズ**: 各モジュールの行数とバンドルサイズ
- **テスト実行時間**: CI/CDでのテスト完了時間

### 検証方法
- **回帰テスト**: 既存Examples/テストでの動作確認
- **性能ベンチマーク**: `tools/benchmark.js` での定量測定
- **メモリプロファイル**: ブラウザDevToolsでのリーク検出
- **コード品質**: SonarQube/ESLintでの静的解析

## Open Questions

### 実装詳細
- **エラーハンドリング**: 各モジュールでのエラー伝播方法
- **ログ出力**: 分散されたモジュール間でのログ整合性
- **設定伝播**: オプションの各モジュールへの効率的な配布方法

### 将来拡張への準備
- **戦略プラグイン**: 外部からの戦略追加メカニズム
- **設定プリセット**: v0.1.11での設定プロファイル実装準備
- **TypeScript移行**: 将来のTypeScript化での型定義準備

### パフォーマンス最適化
- **モジュール遅延読み込み**: 必要時のみモジュール読み込み
- **戦略キャッシュ**: 同一パラメータでの戦略結果キャッシュ
- **並列処理**: 独立したモジュール間での並列実行可能性

## References
- v0.1.9 実装: 選択戦略とAuto Render Budget機能
- `docs/adr/ADR-0006-v0.1.9-adaptive-rendering-and-auto-view.md` との整合性
- リファクタリング原則: Martin Fowler "Refactoring: Improving the Design of Existing Code"
- JavaScript モジュール設計: Kyle Simpson "You Don't Know JS: ES6 & Beyond"
- 戦略パターン: GoF "Design Patterns: Elements of Reusable Object-Oriented Software"
