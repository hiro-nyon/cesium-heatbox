# ADR-0002: v0.1.5 基本機能強化（デバッグ制御・カラーマップ・TopN・API整合）

## Status

Proposed - 2025-08-25 (Introduced-in: v0.1.5)

## Context

v0.1.4で基礎の安定化（自動ボクセルサイズ、重なり解消、統計/デバッグ拡張）を行った。次のv0.1.5ではユーザビリティ向上のため、可視化の基本機能とAPI/ドキュメントの整合性を強化する。

要件はROADMAPの通り：
- デバッグ描画制御: `debug.showBounds` によるバウンディングボックスON/OFF
- 未使用オプション整理: `batchMode: 'auto'` の実装または仕様からの削除
- カラーマップ選択: `viridis` / `inferno` 等の知覚均等カラーマップ
- 二極性データ対応: 発散配色（blue-white-red）
- トップN強調表示: 密度上位ボクセルの強調
- 付随する整合タスク（ドキュメント/ビルド/peer依存の整合）

## Decision

1) デバッグ描画制御（`debug.showBounds`）
- 互換性を保つため、`options.debug` は boolean | { showBounds?: boolean } を許容する。
- booleanの場合: これまで通りログレベル切替。バウンディングボックス表示は`true`時デフォルトON。
- オブジェクトの場合: `showBounds`で境界ボックス表示を明示的に制御（ログは従来どおり `Logger.setLogLevel` が boolean値を判定）。
- 実装変更点: `Logger.setLogLevel`がboolean/オブジェクト双方を扱えるよう軽微に調整。`VoxelRenderer`は`options.debug?.showBounds ?? options.debug === true`で表示判定。

2) `batchMode: 'auto'` の整理
- 現状未使用のため、v0.1.5ではAPIから非推奨化（Deprecated）し、ドキュメントからは削除。
- 互換性のためオプションを受け取っても無害化（無視）し、`debug`時に一度だけ非推奨ワーニングを出力。
- 将来のPrimitiveベース最適化はv0.4.0以降の検討（Roadmap参照）。

3) カラーマップ選択（知覚均等）
- 新オプション `colorMap?: 'viridis' | 'inferno'` を追加。既存のmin/max RGB補間は`colorMap: 'custom'`扱いとして維持。
- 実装は軽量なルックアップ/補間テーブル方式（256段階）でCPU負荷を抑制。
- 互換性: 既存の`minColor/maxColor`指定がある場合はそれを最優先（後方互換）。

4) 二極性データ（発散配色）
- 新オプション `diverging?: boolean` と `divergingPivot?: number`（デフォルト0）を導入。
- 現行の集計は「件数」で非負のため、v0.1.5ではAPIとカラーマッピングの準備のみ提供（値集計の拡張はv0.2.0以降で検討）。
- 互換性: デフォルトは無効。指定時は`blue-white-red`の発散配色テーブルを適用し、ピボットを白にマッピング。

5) トップN強調表示
- 新オプション `highlightTopN?: number` と `highlightStyle?: { outlineWidth?: number; boostOpacity?: number }` を追加。
- 描画リスト生成時に密度降順で上位Nを抽出し、色/不透明度/アウトラインを強調。他ボクセルは淡色（もしくはアルファ低下）で表示。
- 互換性: 指定がなければ従来通り。

6) 整合タスク（ドキュメント/ビルド/peer依存）
- ドキュメントの描画方式表現をEntityベースに統一し、Primitiveは将来予定として注記。
- `peerDependencies.cesium`（^1.120.0）とサンプルCDN（1.120）を見直して一致を保証。
- `package.json`の`main/module/browser/exports`と生成物の整合チェック（CI テンプレ追加は任意）。

## Consequences

### Positive
- **UX向上**: 見やすいカラーマップ、TopNで注目点が分かる、デバッグ可視化の明確な制御
- **API明確化**: 未使用オプションの非推奨化により、APIが整理される
- **一貫性改善**: ドキュメント/ビルド設定/peer依存の整合性向上
- **開発者体験**: デバッグ境界表示により問題特定が容易

### Negative / Risks
- **複雑性増加**: `debug`の型拡張に伴う内部判定の分岐追加（軽微）
- **メンテナンスコスト**: カラーマップ実装でわずかなメンテナンスコスト増
- **段階導入の制約**: 発散配色は「マッピングのみ」で、値集計の本格対応は v0.2.0+
- **非推奨警告**: `batchMode`使用時の警告がユーザー体験に軽微な影響

## Rollout & Migration

- デフォルト挙動は変更せず、オプションを追加する非破壊変更。
- `batchMode`はDeprecated。ドキュメントから除去し、`debug`時に非推奨警告。将来的な削除（v1.0.0候補）をCHANGELOGで予告。
- ドキュメント（API.md / README / Wiki）に新オプションを追加し、例を更新。

## Alternatives Considered

- `debug.showBounds`をトップレベルオプションとする（`debugShowBounds`）。→ オプション命名の拡散を避け、`debug`の下に集約する方針を採用。
- カラーマップの柔軟なプリセット群（magma/plasma等）を一気に追加。→ 段階導入（まずは `viridis/inferno`）。
- 二極性対応をフル実装（重み付け関数や符号付き集計の導入）。→ 影響範囲が広いため、v0.2.0以降の段階導入とする。

## References

- ROADMAP.md: v0.1.5 - 基本機能強化
- CHANGELOG.md: v0.1.5（予定）記載

