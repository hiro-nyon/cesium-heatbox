# ADR-0006: 適応的レンダリング制限とスマート視覚化支援（v0.1.9）

## Status
Proposed - 2025-08-30 (Introduced-in: v0.1.9)

## Context
- v0.1.8 では多言語ドキュメント対応が完了し、英語/日本語バイリンガル体系を確立。
- Playground での運用により2つの主要課題が発見：
  1. **表示の疎化問題**: 密集データで `maxRenderVoxels` 制限時、密度の高い領域のボクセルのみが選択され、低密度の重要領域が可視化から漏れる。
  2. **カメラ不整合問題**: データ境界に対する適切な視点設定が困難で、手動でカメラ調整が必要。
- 現在の密度優先選択（TopK by density）は計算効率的だが、データ全体の分布を把握する用途では不適切な場合がある。
- 自動ボクセルサイズ決定は基本的な `dataSize / maxRenderVoxels` 計算のみで、実際の占有セル数やレンダリング負荷を考慮していない。
  
加えて、端末（GPU/ブラウザ）の実効性能差により、固定既定の `maxRenderVoxels` が過大/過小となり初期体験がばらつく課題がある（モバイルや統合GPUでは重く、デスクトップでは余力が残る）。

→ v0.1.9 では**適応的レンダリング制限**と**スマート視覚化支援**を導入し、ハードニングと合わせて品質向上を図る。

## Decision

### 1) 適応的レンダリング制限（Adaptive Rendering Limits）

#### 1.1 レンダリング制限戦略の拡張
- `renderLimitStrategy: 'density'|'coverage'|'hybrid'` を追加（デフォルト: `'density'`）
  - `'density'`: 既存の密度優先TopK選択（後方互換）
  - `'coverage'`: 空間を格子分割し、各ビンから代表セルを層化抽出（疎領域の視認性向上）
  - `'hybrid'`: 密度TopKと層化抽出を組み合わせ、バランスの取れた選択

#### 1.2 カバレッジ制御パラメータ
- `minCoverageRatio: number` (0–1, デフォルト: 0.2): hybrid戦略で層化抽出に割り当てる最小比率
- `coverageBinsXY: number | 'auto'` (デフォルト: `'auto'`): 層化抽出用の格子分割数
  - `'auto'`: データ範囲とセル密度から自動計算
  - 数値: 明示的なビン数指定（X/Y軸共通）

#### 1.3 統計情報の拡張
- `getStatistics()` に以下を追加:
  - `selectionStrategy: string`: 実際に使用された選択戦略
  - `clippedNonEmpty: number`: 制限により除外されたセル数
  - `coverageRatio: number`: 層化抽出の実効比率（hybridモード時）
  
補足（TopNとの連携）:
- `highlightTopN` は選択戦略に関わらず強制包含される（TopNのボクセルは必ず選択対象に含む）。
 
補足（coverageRatioの定義）:
- non-hybrid モード（density / coverage）では `coverageRatio` は 0（もしくは null）とする。

### 2) 自動ボクセルサイズ決定の強化

#### 2.1 占有率ベース計算の導入
- `autoVoxelSizeMode: 'basic'|'occupancy'` を追加（デフォルト: `'basic'`）
  - `'basic'`: 既存の簡易計算（後方互換）
  - `'occupancy'`: 期待占有セル数を考慮した反復近似

#### 2.2 占有率計算ロジック
- 期待占有セル数: `E[occupied] ≈ M × (1 - exp(-N/M))`
  - `N`: データポイント数
  - `M`: 総ボクセル数
- `autoVoxelTargetFill: number` (0–1, デフォルト: 0.6): 目標占有率
- `maxRenderVoxels` と `autoVoxelTargetFill` に整合するサイズを反復近似で決定
  
責務分離（重要）:
- 自動ボクセルサイズは「初期グリッド決定専用」。既定では描画後のグリッド再構築は行わない（分類や見た目の揺れを回避）。
- 可視化の適応（疎密のバランスや負荷の調整）は“選抜側（renderLimitStrategy と上限K）”で行う。

### 3) スマート視覚化支援（Smart View Assistance）

#### 3.1 自動視点調整
- `autoView: boolean` (デフォルト: `false`): 自動視点調整の有効化
- `Heatbox.fitView(bounds, options)` メソッドを公開
  - `bounds`: 対象境界（省略時はデータ全体）
  - `options`: 視点調整パラメータ
    - `paddingMeters?: number` (デフォルト: データ範囲の10%)
    - `pitch?: number` (デフォルト: -30°)
    - `heading?: number` (デフォルト: 0°)
    - `altitudeStrategy?: 'auto'|'manual'` (デフォルト: `'auto'`)

#### 3.2 カメラ計算ロジック
- データ境界に対し、ピッチ/視野角を考慮した適切な高度を自動計算
- フォールバック: `Camera.flyToBoundingSphere` を利用
- 端ケース（極小/極大データ）での安定化

### 4) 端末依存の自動レンダリング上限（Auto Render Budget）

#### 4.1 コンセプト
- 端末の能力に応じて初期の描画上限K（`maxRenderVoxels`）を自動設定し、初期体験を安定化する。
- 後方互換を維持し、オプトイン（`'auto'` 指定、または `renderBudgetMode: 'auto'`）時のみ自動化。

#### 4.2 API
- `maxRenderVoxels: number | 'auto'`（または `renderBudgetMode: 'manual'|'auto'`）
- 統計拡張: `renderBudgetTier`（'low'|'mid'|'high'）、`autoMaxRenderVoxels` を追加

#### 4.3 ティア推定の素材（取得可能な範囲）
- WebGL2可否、`MAX_TEXTURE_SIZE`/`MAX_RENDERBUFFER_SIZE`
- `navigator.deviceMemory`（GB, Chrome系のみ対応）、`navigator.hardwareConcurrency`、`devicePixelRatio`
- **フォールバック戦略**: `deviceMemory` 未対応時は `hardwareConcurrency` と画面解像度（`screen.width × screen.height × devicePixelRatio²`）を主指標として使用
- 最終的に取得不可時は中ティアにフォールバックし、`PERFORMANCE_LIMITS.maxVoxels` でクランプ

#### 4.4 出力レンジ（目安）
- 低ティア: 8,000–12,000 / 中ティア: 20,000–35,000 / 高ティア: 40,000–50,000

#### 4.5 相互作用
- 選択戦略（density/coverage/hybrid）はユーザー選択のまま、上限Kのみ自動初期化。
- `autoVoxelSizeMode: 'occupancy'` と併用可（初期グリッドは占有率で、Kは端末で決める）。

### 5) ハードニング要件

#### 4.1 品質ゲート
- Lint errors: 0 (継続維持)
- 単体テスト追加:
  - `VoxelRenderer` の選択戦略（density/coverage/hybrid）
  - `Heatbox.updateOptions` の再描画分岐
  - 占有率計算の数値精度
  - Auto Render Budget のティア別レンジの検証

#### 4.2 Examples更新
- Basic/Advanced の初期設定を新フラグに対応
- 新機能のデモンストレーション用UI追加

## Consequences

### Positive
- 可視性の公平性: 疎密混在でも低密度領域が確実に残る（coverage/hybrid）。
- 安定性能: 占有率ベースの自動サイズで過不足の少ないセル数に収束。
- 初期体験の改善: `autoView` により手動のカメラ調整が大幅に減る。
- 端末差の緩和: Auto Render Budget により端末ごとに安全な初期Kで開始できる。
- 後方互換: 既存デフォルトは不変で、全機能はオプトイン。

### Negative / Risks
- 複雑性増加: 抽出戦略・パラメータが増え学習コストが上がる。
- 性能オーバーヘッド: 層化抽出/反復近似の追加計算（制約は<10%を目標）。
- デバッグ難度: 選択の理由が見えづらくなる可能性（可視化/統計で緩和）。
- 依存挙動: Cesium Camera の仕様差分により視点調整が揺れるリスク。

## Alternatives Considered

### レンダリング制限の代替案
- **完全ランダムサンプリング**: 実装は簡単だが、重要領域の保証がない
- **ユーザー定義重要度**: 柔軟だが0.1系のスコープを超える
- **適応的グリッドサイズ**: 複雑で性能オーバーヘッドが大きい

### 視点調整の代替案
- **固定視点プリセット**: 汎用性に欠ける
- **手動設定のみ**: ユーザビリティが低い
- **機械学習ベース**: オーバーエンジニアリング

## Interactions

### 既存機能との連携
- `highlightTopN`: 選択戦略と連動し、TopN要素は必ず選択対象に含む
- `adaptiveOutlines` (v0.1.7): 新しい選択戦略にも適応的制御を適用
- `wireframeOnly`: 各選択戦略で一貫動作

### 設定の優先順位
1. ユーザー明示設定（最優先）
2. 適応的ヒューリスティクス
3. デフォルト値

## Constraints

### 技術制約
- Entityベース実装の継続（0.1系）
- 抽出戦略のオーバーヘッド: <10%（複雑化への対応）
- メモリ使用量: 既存の150%以下

### 互換性制約
- 既存APIの後方互換性維持
- デフォルト動作の変更なし（新機能はオプトイン）

### 性能制約
- 占有率計算の反復: 最大10回（収束/タイムアウト）
- `fitView` 処理時間: <200ms（体感遅延の回避）

## Acceptance Criteria

### 機能要件
- [ ] **疎密混在データテスト**: `maxRenderVoxels: 300` で `renderLimitStrategy: 'hybrid'` 使用時、低密度セルが最低限可視化される（`coverageRatio ≥ 0.3`）
- [ ] **占有率制御**: `autoVoxelSizeMode: 'occupancy'` 有効時、`renderedVoxels / maxRenderVoxels` が 0.4–0.8 に収まる
- [ ] **自動視点調整**: `autoView: true` でデータ境界が10%パディング付きでフレーム内に収まる（ピッチ-30°でも欠落なし）
- [ ] **品質ゲート**: Lint 0 errors、追加テストすべて緑、Basic/Advanced が初期状態で正常動作
- [ ] **Auto Render Budget**: `'auto'` 指定時、低ティアで `autoMaxRenderVoxels ≤ 12,000`、高ティアで `autoMaxRenderVoxels ≥ 40,000`（いずれも `PERFORMANCE_LIMITS.maxVoxels` 以下）

### 性能要件
- [ ] **選択オーバーヘッド**: 各戦略で既存比<110%の処理時間
- [ ] **メモリ安定性**: 複数回描画/再設定でリークなし
- [ ] **統計情報**: `getStatistics()` で選択戦略と除外数が正確に報告される

### ユーザビリティ要件
- [ ] **ドキュメント整備**: Playground既知課題と解法をチューニングFAQに追記
- [ ] **設定例**: 各戦略の推奨ユースケースを Examples/Wiki で解説
- [ ] **Debug支援**: `debug: true` で選択戦略の動作を可視化

## Rollout & Migration

### Phase 1: コア実装（Week 1-2）
- [ ] `renderLimitStrategy` の実装（density/coverage/hybrid）
- [ ] `autoVoxelSizeMode: 'occupancy'` の実装（初期グリッド専任、既定で再構築なし）
- [ ] Auto Render Budget（`maxRenderVoxels: 'auto'`）の実装
- [ ] 基本的な単体テスト

### Phase 2: 視覚化支援（Week 3）
- [ ] `fitView` メソッドと `autoView` オプション
- [ ] カメラ計算ロジックの実装
- [ ] エラーハンドリングとフォールバック

### Phase 3: 統合とテスト（Week 4）
- [ ] Examples の更新（新戦略/Auto Budget UI 反映）
- [ ] 統計情報の拡張（選抜メタ + Auto Budget ティア）
- [ ] 性能テストとドキュメント整備

移行ポリシー:
- 既定挙動は変更しない（すべてオプトイン）。
- ドキュメント（`docs/API.md`, `docs/quick-start.md`, Wiki）を同時更新。

## Open Questions

### 実装詳細
- **層化抽出のビン分割**: 正方格子 vs 適応的分割の選択基準
- **占有率計算の収束条件**: 相対誤差1% vs 絶対差N個のしきい値設定
- **統計情報の更新タイミング**: レンダリング後 vs リアルタイム
- **端末ティア推定**: ブラウザから取得可能な指標の優先順位と境界値設定（低/中/高）
  - `deviceMemory` 利用可能時: ≤4GB→低、4-8GB→中、8GB+→高
  - フォールバック時: `hardwareConcurrency` (≤4→低、4-8→中、8+→高) × 画面解像度補正

### ユーザビリティ
- **プリセット設定**: 密集/疎/混在データ用の推奨設定セットの必要性
- **Debug表示**: 選択戦略の効果を視覚的に確認する方法
- **エラーメッセージ**: 設定不整合時の分かりやすいガイダンス

### 将来拡張への準備
- **選択戦略の拡張性**: プラグイン化の可能性
- **統計情報API**: 外部ツールとの連携を考慮した設計
- **性能モニタリング**: 本番環境での品質監視方法
  - **Auto Quality（FPSベース微調整）**: v0.1.10で“選抜側のつまみ”のみを実測FPSに合わせて微調整する方針（グリッド再構築なし）

## References
- Playground運用フィードバック（表示疎化/カメラ不整合の具体例）
- `docs/adr/ADR-0001-auto-voxel-size-implementation.md`（自動ボクセルサイズ）との整合性
- 統計学習理論における層化抽出手法
- CesiumJS Camera API仕様
