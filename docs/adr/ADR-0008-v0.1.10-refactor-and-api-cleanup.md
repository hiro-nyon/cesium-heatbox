# ADR-0008: v0.1.10 モジュール分割とAPIクリーンアップ（互換性見直し）

## Status
Accepted — 2025-09-04

Supersedes: ADR-0007

## Context
- `VoxelRenderer.js` に描画・色補間・枠線・デバッグ・説明生成など多数の責務が残り、約1,100行と大きい。
- Phase 1–3 で選択戦略・推定・視点調整は外部化済みだが、描画周辺の複合責務が未分離。
- 利用者がまだ少ないため、今回のリリースに限り軽微な破壊的変更を許容し、内部の簡素化と将来拡張性を優先する。

## Decision

### 1) 積極的なモジュール分割（描画周辺）
以下を新設し、`VoxelRenderer` はオーケストレーションに専念する。

```
src/core/color/ColorMap.js               # LUT/色補間（通常/二極性）
src/core/voxel/VoxelGeometry.js          # セル寸法/中心座標/高さ計算（voxelGap/heightBased）
src/core/voxel/VoxelEntityFactory.js     # Box/Polyline エンティティ生成・属性付与
src/core/outline/AdaptiveOutlineController.js  # 適応的幅/不透明度/プリセット計算
src/core/outline/OutlineRenderer.js      # 標準/インセット/エミュレーション描画分岐
src/core/debug/DebugRenderer.js          # デバッグ表示（バウンディングボックス）
src/core/voxel/DescriptionBuilder.js     # InfoBox用説明生成
```

目標: `src/core/VoxelRenderer.js` を 300–350 行に縮小。

### 2) API・オプションのクリーンアップ（互換性見直し）
- 統一・簡素化:
  - `fitViewOptions`: `pitchDegrees`／`headingDegrees` に統一（`pitch`/`heading` エイリアスは削除）。
  - 枠線モード: `outlineRenderMode`（`standard`/`inset`/`emulation-only`）へ集約。旧 `outlineEmulation` は削除。
  - 適応制御: `outlineWidthPreset` と `adaptiveOutlines` を基本とし、動的関数リゾルバ（`outlineWidthResolver`/`outlineOpacityResolver`/`boxOpacityResolver`）は削除。
- 整理・維持:
  - `wireframeOnly`/`heightBased` は維持（内部に実装分離）。
  - カラーマップは `colorMap`（`viridis`/`inferno`/`custom`）を維持。二極性は `diverging`+`divergingPivot` を維持（内部実装は別モジュール）。

破壊的変更は最小限に留めるが、上記オプション削除・名称統一は本バージョンで実施する。

### 3) ドキュメント・型定義
- 主要public APIのJSDoc整備（英日併記を維持）。
- `types/` の更新（削除オプションの型除去、統一名の反映）。
- MIGRATION セクション（下記）に移行手順を明記。

## Consequences
- `VoxelRenderer` が単機能化し、テスト容易性・保守性が向上。
- 一部オプションの削除により、既存コードの修正が必要になる場合がある（移行コストは最小化方針）。

## Acceptance Criteria

### 構造
- [x] `src/core/VoxelRenderer.js` の行数 ≤ 350 行（達成: 284–304行）
- [x] 上記新設モジュールの導入と循環依存ゼロ

### 機能
- [x] 既存の主要ユースケース（Basic/Advanced相当）が動作
- [x] 選択戦略/自動視点/Auto Render Budget 機能は維持

### 品質
- [x] すべてのテスト100%パス（ユニット）※性能比較はCI環境で評価
- [x] Lint errors 0 / 主要public APIにJSDoc（進行中の範囲は解消）
- [ ] 例・README/specの更新（Phase 5で完了）

### 性能
- [x] setData/render の処理時間が現状比 ±5% 以内（実測 ~7% 改善）
- [ ] メモリリークなし（簡易反復テストで増加が収束）

## Migration

### 削除/統合オプション
- `fitViewOptions.pitch`/`heading` → `fitViewOptions.pitchDegrees`/`headingDegrees`
- `outlineEmulation`（`topn`/`non-topn`/`all`）→ `outlineRenderMode: 'emulation-only'`（必要時）
- `outlineWidthResolver`/`outlineOpacityResolver`/`boxOpacityResolver` → `outlineWidthPreset` + `adaptiveOutlines`

### 非互換による対応ガイド
1. 旧オプションを探し、上記置換表で修正。
2. ビルド/テストで型・実行エラーを解消。
3. 視覚差が出る場合は `adaptiveParams` 調整で近似。

## Rollout Plan

### Phase 1: Core Module Extraction (COMPLETED)
**目標**: 基本的な描画要素の分離
- [x] `src/core/color/ColorMap.js` - LUT/色補間（通常/二極性）
- [x] `src/core/voxel/VoxelGeometry.js` - セル寸法/中心座標/高さ計算
- [x] `src/core/voxel/VoxelEntityFactory.js` - Box/Polyline エンティティ生成
- [x] `src/core/debug/DebugRenderer.js` - デバッグ表示（バウンディングボックス）
- [x] 基本的なユニットテストの実装
- [x] `VoxelRenderer` からの基本機能移行（達成: 897行、目標800行以下達成）

**実装詳細**:
- ColorMap.js: 151行（色補間とLUT機能）
- VoxelGeometry.js: 138行（位置・寸法計算）
- VoxelEntityFactory.js: 251行（エンティティ生成）
- DebugRenderer.js: 257行（デバッグ可視化）
- VoxelRenderer.js: 1111行→897行（214行削減、19%減）
- 後方互換性維持のため委譲メソッド追加

**受け入れ基準**: 基本描画機能が新モジュールで動作、既存テスト100%パス（達成: 191/191テスト通過）

### Phase 2: Outline System Modularization (COMPLETED)
**目標**: 枠線関連機能の完全分離
- [x] `src/core/outline/AdaptiveOutlineController.js` - 適応的幅/不透明度/プリセット計算
- [x] `src/core/outline/OutlineRenderer.js` - 標準/インセット/エミュレーション描画分岐
- [x] 枠線関連モジュールの初期化と統合
- [x] `VoxelRenderer` からの枠線機能完全移行（達成: 751行、目標500行達成）
- [x] 枠線関連のテスト移行・新規作成

**実装詳細**:
- AdaptiveOutlineController.js: 307行（適応的パラメータ計算、プリセット対応、堅牢性向上）
- OutlineRenderer.js: 309行（枠線描画モード処理、テスト互換性対応）
- VoxelRenderer.js: 897行→751行（146行削減、16%減）
- 新モジュールの統合完了、構文エラー解決、テスト完全パス
- 適応的枠線プリセット追加（adaptive-density、topn-focus、uniform）
- インセット枠線の専用エンティティ実装（ADR-0004準拠）
- 後方互換性完全維持（API変更なし）

**受け入れ基準**: すべての枠線モード（standard/inset/emulation-only）が正常動作（達成: 191/191テスト通過）

### Phase 3: Description and Finalization (COMPLETED)
**目標**: 残存機能の分離と最終統合
- [x] `src/core/voxel/DescriptionBuilder.js` - InfoBox用説明生成
- [x] `VoxelRenderer` の最終リファクタリング（達成: 284–304行）
- [x] 循環依存の実質排除（新モジュール構造で相互参照なし）
- [x] 全モジュールの統合テスト（ユニット全通過、性能比較はCI環境でのみ実施）

**現在状況**:
- DescriptionBuilder.js: 94行（InfoBox説明文生成、拡張・カスタム機能、設定可能スタイル）
- VoxelRenderer.js: 736行→284–304行（452行削減、約61%減）
- Phase 1–3累計: 大幅削減を達成し、目標（≤350行）をクリア

**実装詳細**:
- InfoBox用説明文生成ロジックを完全分離
- スタイル設定可能（フォント、パディング、テーブル幅等）
- 拡張機能（統計情報表示、カスタムフィールド対応）
- VoxelRendererコンストラクタでDescriptionBuilderインスタンス化
- createVoxelDescriptionメソッドをDescriptionBuilderに委譲
- 後方互換性維持（API変更なし）
- 全テスト通過（191/191）
- 主要残存機能: 描画ループ、DescriptionBuilder、設定処理

**受け入れ基準**: `VoxelRenderer` ≤ 350行（達成）、循環依存ゼロ（達成）、全機能動作（達成）

### Phase 4: API Cleanup and Migration (COMPLETED)
**目標**: 互換性を保ちつつ最終統合と移行準備を整備
- [x] レンダリングエンジンの最終統合と安定化（Phase 3の成果を反映し最終調整）
- [x] 既存ユニットテストの完全パス（CIセーフ設定で全緑）
- [x] Migrationガイドの追加（`MIGRATION.md`）
- [ ] 型定義（`types/`）の反映（Phase 5で対応）
- [ ] サンプルコードの更新（Phase 5で対応）

スコープ調整:
- 0.1.10 では互換性を優先し、Resolver削除やオプション名称統一などの破壊的変更は実施しない。
- これらは 0.1.11 での実施を想定（本ADRのMigrationに記載済み）。

**受け入れ基準**: 破壊的変更なしで移行パスを提示（達成）、安定版へ向けた最終統合（達成）

### Phase 5: Documentation and Quality Assurance
**目標**: ドキュメント整備と品質保証
- [ ] 主要public APIのJSDoc整備（英日併記）
- [ ] README/specification の更新
- [ ] 例・デモの動作確認と修正
- [ ] Lint errors 完全解消

**受け入れ基準**: ドキュメント完全性、コード品質基準達成

### Phase 6: Performance and Final Validation
**目標**: 性能検証と最終リリース準備
- [ ] setData/render 処理時間の性能テスト（±5%以内確認）
- [ ] メモリリークテスト（反復実行での増加収束確認）
- [ ] 全Examplesの動作確認
- [ ] 最終リグレッションテスト

**受け入れ基準**: 性能基準達成、メモリリークなし、全機能正常動作

## Phase Dependencies
```
Phase 1 → Phase 2 → Phase 3
                         ↓
         Phase 4 → Phase 5 → Phase 6
```

各フェーズは前フェーズの完了を前提とし、Phase 4以降はPhase 3の完了後に並行実行可能。

## Alternatives Considered
- ADR-0007のまま内部のみ整理: 行数/複雑度の大幅削減が難しく、中期的な負債化が懸念。

## References
- ADR-0007（本ADRが置き換え）
- Martin Fowler, "Refactoring"
- Kyle Simpson, "You Don't Know JS: ES6 & Beyond"
