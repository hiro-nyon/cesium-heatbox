# ADR-0008: v0.1.10 モジュール分割とAPIクリーンアップ（互換性見直し）

## Status
Accepted — 2025-09-04

Supersedes: ADR-0007

## Context
- `VoxelRenderer.js` に描画・色補間・枠線・デバッグ・説明生成など多数の責務が残り、約1,100行と大きい。
- Phase 1–3 で選択戦略・推定・視点調整は外部化済みだが、描画周辺の複合責務が未分離。
- 利用者がまだ少ないため、今回のリリースに限り軽微な破壊的変更を許容し、内部の簡素化と将来拡張性を優先する。

## Decision

### 1) 積極的なモジュール分割（描画周辺）
以下を新設し、`VoxelRenderer` はオーケストレーションに専念する。

```
src/core/color/ColorMap.js               # LUT/色補間（通常/二極性）
src/core/voxel/VoxelGeometry.js          # セル寸法/中心座標/高さ計算（voxelGap/heightBased）
src/core/voxel/VoxelEntityFactory.js     # Box/Polyline エンティティ生成・属性付与
src/core/outline/AdaptiveOutlineController.js  # 適応的幅/不透明度/プリセット計算
src/core/outline/OutlineRenderer.js      # 標準/インセット/エミュレーション描画分岐
src/core/debug/DebugRenderer.js          # デバッグ表示（バウンディングボックス）
src/core/voxel/DescriptionBuilder.js     # InfoBox用説明生成
```

目標: `src/core/VoxelRenderer.js` を 300–350 行に縮小。

### 2) API・オプションのクリーンアップ（互換性見直し）
- 統一・簡素化:
  - `fitViewOptions`: `pitchDegrees`／`headingDegrees` に統一（`pitch`/`heading` エイリアスは削除）。
  - 枠線モード: `outlineRenderMode`（`standard`/`inset`/`emulation-only`）へ集約。旧 `outlineEmulation` は削除。
  - 適応制御: `outlineWidthPreset` と `adaptiveOutlines` を基本とし、動的関数リゾルバ（`outlineWidthResolver`/`outlineOpacityResolver`/`boxOpacityResolver`）は削除。
- 整理・維持:
  - `wireframeOnly`/`heightBased` は維持（内部に実装分離）。
  - カラーマップは `colorMap`（`viridis`/`inferno`/`custom`）を維持。二極性は `diverging`+`divergingPivot` を維持（内部実装は別モジュール）。

破壊的変更は最小限に留めるが、上記オプション削除・名称統一は本バージョンで実施する。

### 3) ドキュメント・型定義
- 主要public APIのJSDoc整備（英日併記を維持）。
- `types/` の更新（削除オプションの型除去、統一名の反映）。
- MIGRATION セクション（下記）に移行手順を明記。

## Consequences
- `VoxelRenderer` が単機能化し、テスト容易性・保守性が向上。
- 一部オプションの削除により、既存コードの修正が必要になる場合がある（移行コストは最小化方針）。

## Acceptance Criteria

### 構造
- [ ] `src/core/VoxelRenderer.js` の行数 ≤ 350 行
- [ ] 上記新設モジュールの導入と循環依存ゼロ

### 機能
- [ ] 既存の主要ユースケース（Basic/Advanced相当）が動作
- [ ] 選択戦略/自動視点/Auto Render Budget 機能は維持

### 品質
- [ ] すべてのテスト100%パス（必要に応じてテスト更新）
- [ ] Lint errors 0 / 主要public APIにJSDoc
- [ ] 例・README/specの更新

### 性能
- [ ] setData/render の処理時間が現状比 ±5% 以内
- [ ] メモリリークなし（簡易反復テストで増加が収束）

## Migration

### 削除/統合オプション
- `fitViewOptions.pitch`/`heading` → `fitViewOptions.pitchDegrees`/`headingDegrees`
- `outlineEmulation`（`topn`/`non-topn`/`all`）→ `outlineRenderMode: 'emulation-only'`（必要時）
- `outlineWidthResolver`/`outlineOpacityResolver`/`boxOpacityResolver` → `outlineWidthPreset` + `adaptiveOutlines`

### 非互換による対応ガイド
1. 旧オプションを探し、上記置換表で修正。
2. ビルド/テストで型・実行エラーを解消。
3. 視覚差が出る場合は `adaptiveParams` 調整で近似。

## Rollout Plan

### Phase 1: Core Module Extraction
**目標**: 基本的な描画要素の分離
- [ ] `src/core/color/ColorMap.js` - LUT/色補間（通常/二極性）
- [ ] `src/core/voxel/VoxelGeometry.js` - セル寸法/中心座標/高さ計算
- [ ] `src/core/voxel/VoxelEntityFactory.js` - Box/Polyline エンティティ生成
- [ ] `src/core/debug/DebugRenderer.js` - デバッグ表示（バウンディングボックス）
- [ ] 基本的なユニットテストの実装
- [ ] `VoxelRenderer` からの基本機能移行（目標: 800行以下）

**受け入れ基準**: 基本描画機能が新モジュールで動作、既存テスト100%パス

### Phase 2: Outline System Modularization  
**目標**: 枠線関連機能の完全分離
- [ ] `src/core/outline/AdaptiveOutlineController.js` - 適応的幅/不透明度/プリセット計算
- [ ] `src/core/outline/OutlineRenderer.js` - 標準/インセット/エミュレーション描画分岐
- [ ] 枠線関連のテスト移行・新規作成
- [ ] `VoxelRenderer` からの枠線機能完全移行（目標: 500行以下）

**受け入れ基準**: すべての枠線モード（standard/inset/emulation-only）が正常動作

### Phase 3: Description and Finalization
**目標**: 残存機能の分離と最終統合
- [ ] `src/core/voxel/DescriptionBuilder.js` - InfoBox用説明生成
- [ ] `VoxelRenderer` の最終リファクタリング（目標: 300-350行）
- [ ] 循環依存の完全排除確認
- [ ] 全モジュールの統合テスト

**受け入れ基準**: `VoxelRenderer` ≤ 350行、循環依存ゼロ、全機能動作

### Phase 4: API Cleanup and Migration
**目標**: APIの統一・簡素化と移行対応
- [ ] オプション統一・削除の実装
  - `fitViewOptions`: `pitchDegrees`/`headingDegrees` への統一
  - `outlineRenderMode` への集約（`outlineEmulation` 削除）
  - 動的関数リゾルバの削除
- [ ] 型定義の更新（`types/` ディレクトリ）
- [ ] 移行ガイドの詳細化
- [ ] サンプルコードの更新

**受け入れ基準**: 破壊的変更の最小化、移行パスの明確化

### Phase 5: Documentation and Quality Assurance
**目標**: ドキュメント整備と品質保証
- [ ] 主要public APIのJSDoc整備（英日併記）
- [ ] README/specification の更新
- [ ] 例・デモの動作確認と修正
- [ ] Lint errors 完全解消

**受け入れ基準**: ドキュメント完全性、コード品質基準達成

### Phase 6: Performance and Final Validation
**目標**: 性能検証と最終リリース準備
- [ ] setData/render 処理時間の性能テスト（±5%以内確認）
- [ ] メモリリークテスト（反復実行での増加収束確認）
- [ ] 全Examplesの動作確認
- [ ] 最終リグレッションテスト

**受け入れ基準**: 性能基準達成、メモリリークなし、全機能正常動作

## Phase Dependencies
```
Phase 1 → Phase 2 → Phase 3
                         ↓
         Phase 4 → Phase 5 → Phase 6
```

各フェーズは前フェーズの完了を前提とし、Phase 4以降はPhase 3の完了後に並行実行可能。

## Alternatives Considered
- ADR-0007のまま内部のみ整理: 行数/複雑度の大幅削減が難しく、中期的な負債化が懸念。

## References
- ADR-0007（本ADRが置き換え）
- Martin Fowler, "Refactoring"
- Kyle Simpson, "You Don't Know JS: ES6 & Beyond"

