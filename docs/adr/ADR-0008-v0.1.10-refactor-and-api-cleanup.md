# ADR-0008: v0.1.10 モジュール分割とAPIクリーンアップ（互換性見直し）

## Status
Accepted — 2025-09-04

Supersedes: ADR-0007

## Context
- `VoxelRenderer.js` に描画・色補間・枠線・デバッグ・説明生成など多数の責務が残り、約1,100行と大きい。
- Phase 1–3 で選択戦略・推定・視点調整は外部化済みだが、描画周辺の複合責務が未分離。
- 利用者がまだ少ないため、今回のリリースに限り軽微な破壊的変更を許容し、内部の簡素化と将来拡張性を優先する。

## Decision

### 1) 積極的なモジュール分割（描画周辺）
以下を新設し、`VoxelRenderer` はオーケストレーションに専念する。

```
src/core/color/ColorMap.js               # LUT/色補間（通常/二極性）
src/core/voxel/VoxelGeometry.js          # セル寸法/中心座標/高さ計算（voxelGap/heightBased）
src/core/voxel/VoxelEntityFactory.js     # Box/Polyline エンティティ生成・属性付与
src/core/outline/AdaptiveOutlineController.js  # 適応的幅/不透明度/プリセット計算
src/core/outline/OutlineRenderer.js      # 標準/インセット/エミュレーション描画分岐
src/core/debug/DebugRenderer.js          # デバッグ表示（バウンディングボックス）
src/core/voxel/DescriptionBuilder.js     # InfoBox用説明生成
```

目標: `src/core/VoxelRenderer.js` を 300–350 行に縮小。

### 2) API・オプションのクリーンアップ（互換性見直し）
- 統一・簡素化:
  - `fitViewOptions`: `pitchDegrees`／`headingDegrees` に統一（`pitch`/`heading` エイリアスは削除）。
  - 枠線モード: `outlineRenderMode`（`standard`/`inset`/`emulation-only`）へ集約。旧 `outlineEmulation` は削除。
  - 適応制御: `outlineWidthPreset` と `adaptiveOutlines` を基本とし、動的関数リゾルバ（`outlineWidthResolver`/`outlineOpacityResolver`/`boxOpacityResolver`）は削除。
- 整理・維持:
  - `wireframeOnly`/`heightBased` は維持（内部に実装分離）。
  - カラーマップは `colorMap`（`viridis`/`inferno`/`custom`）を維持。二極性は `diverging`+`divergingPivot` を維持（内部実装は別モジュール）。

破壊的変更は最小限に留めるが、上記オプション削除・名称統一は本バージョンで実施する。

### 3) ドキュメント・型定義
- 主要public APIのJSDoc整備（英日併記を維持）。
- `types/` の更新（削除オプションの型除去、統一名の反映）。
- MIGRATION セクション（下記）に移行手順を明記。

## Consequences
- `VoxelRenderer` が単機能化し、テスト容易性・保守性が向上。
- 一部オプションの削除により、既存コードの修正が必要になる場合がある（移行コストは最小化方針）。

## Acceptance Criteria

### 構造
- [ ] `src/core/VoxelRenderer.js` の行数 ≤ 350 行
- [ ] 上記新設モジュールの導入と循環依存ゼロ

### 機能
- [ ] 既存の主要ユースケース（Basic/Advanced相当）が動作
- [ ] 選択戦略/自動視点/Auto Render Budget 機能は維持

### 品質
- [ ] すべてのテスト100%パス（必要に応じてテスト更新）
- [ ] Lint errors 0 / 主要public APIにJSDoc
- [ ] 例・README/specの更新

### 性能
- [ ] setData/render の処理時間が現状比 ±5% 以内
- [ ] メモリリークなし（簡易反復テストで増加が収束）

## Migration

### 削除/統合オプション
- `fitViewOptions.pitch`/`heading` → `fitViewOptions.pitchDegrees`/`headingDegrees`
- `outlineEmulation`（`topn`/`non-topn`/`all`）→ `outlineRenderMode: 'emulation-only'`（必要時）
- `outlineWidthResolver`/`outlineOpacityResolver`/`boxOpacityResolver` → `outlineWidthPreset` + `adaptiveOutlines`

### 非互換による対応ガイド
1. 旧オプションを探し、上記置換表で修正。
2. ビルド/テストで型・実行エラーを解消。
3. 視覚差が出る場合は `adaptiveParams` 調整で近似。

## Rollout Plan
1. Color/Geometry/Entity/Debug の分離（小PRに分割）
2. Outline系（Adaptive/Renderer）の分離
3. APIクリーンアップと移行対応（types/README/spec更新、サンプル修正）
4. 最終リグレッション（性能/メモリ・Examples）

## Alternatives Considered
- ADR-0007のまま内部のみ整理: 行数/複雑度の大幅削減が難しく、中期的な負債化が懸念。

## References
- ADR-0007（本ADRが置き換え）
- Martin Fowler, "Refactoring"
- Kyle Simpson, "You Don't Know JS: ES6 & Beyond"

