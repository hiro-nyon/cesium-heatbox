# ADR-0015: Global Spatial ID QA - v0.1.19

**Status**: Proposed  
**Date**: 2025-11-18  
**Author**: hiro-nyon  
**Target Version**: v0.1.19  
**Related**: ROADMAP v0.1.19, ADR-0013

## Context / 背景

### Problem Statement / 問題提起

v0.1.17（ADR-0013）で導入した Spatial ID 対応（tile-grid モード）は、日常的な利用パターンでは十分に動作していますが、以下の **グローバル端ケース** については体系的な検証と仕様の明文化が不足しています：

1. **±180° 付近のラップ挙動**
   - 経度 +179.9°E ↔ -179.9°W など、日付変更線付近でタイルが隣接するケース。
   - 線形な経度差ではなく、-180°〜+180° のラップを伴うため、隣接セルの定義が直感的でない。

2. **±85.0511° 近傍（高緯度）**
   - Web Mercator の有効範囲上限（約 ±85.0511°）近傍では、XY スケールが極端に変形。
   - タイルの縦横比や面積が大きく変動し、投影誤差および数値誤差に敏感。

3. **半球跨ぎ・経度正規化の境界**
   - 東経 170°〜西経 -170° のように、バウンディングボックスが半球を跨ぐケース。
   - `bounds` / `center` / `neighbors` 等の API で、経度正規化（-180°〜+180°／0〜360°）の違いが不整合を生みやすい。

これらのケースで Spatial ID ベースのタイル境界と Heatbox のボクセル生成・統計の間に矛盾があると、以下の問題が生じます。

- タイル境界とボクセル境界がズレ、地図上の位置感覚が崩れる。
- 親子/近傍セル探索（`neighbors`/`children`/`parent`）の連続性が破綻し、「隣接しているはずのセルが取れない／余分なセルが混ざる」といった不具合が起こる。
- Spatial ID を用いた外部システムとの連携（メッシュ集計・タイルキャッシュ・可視化ツール間のデータ交換）が信頼しづらくなる。

ROADMAP v0.1.19 では、これらグローバル端ケースの QA を v0.1 系の仕上げとして位置付けており、v1.x 移行前に「Spatial ID モードはグローバル座標系においても仕様どおり動作する」ことを保証する必要があります。

### Existing Behavior / 現状

#### 1. Spatial ID モードの利用方法

- Spatial ID モードは `spatialId: { enabled: true, mode: 'tile-grid', zoomControl: 'auto'|'manual' }` としてオプトインで使用。
- ズームは固定値または `zoomControl: 'auto'` による自動選択。
- ZFXY 変換およびタイル境界計算は、以下のいずれかを使用：
  - ouranos-gex-lib-for-javascript（Ouranos）: METI 準拠の Spatial ID 実装。
  - フォールバック ZFXYConverter: ouranos-gex 不在時の代替。

#### 2. 統計・メタデータ

- `Heatbox.getStatistics()` は以下に相当するフィールドを返却（詳細は実装に依存）：
  - `spatialIdEnabled: boolean`
  - `spatialIdProvider: 'ouranos-gex' | 'fallback' | null`
  - `spatialIdZoom: number | null`
  - `zoomControl: 'auto' | 'manual' | null`
- ただし、これらは主に「今どのモードで動いているか」を示すメタ情報に留まり、グローバル端ケースの QA 用メトリクスやテストシナリオは明確に定義されていない。

#### 3. ドキュメント

- README / Wiki / `wiki/Spatial-ID-Setup.md` には、基本的なセットアップ手順と Ouranos／フォールバックの選択方法が記載されている。
- 一方で、±180°・高緯度・半球跨ぎなどの **端ケース固有の挙動や制限事項** はほとんど言及されておらず、運用者が自力で検証する必要がある。

## Goals / 非目標を含むスコープ

### Goals / 目標

v0.1.19 の主目的は、「Spatial ID tile-grid モードの **グローバル QA を体系化し、テストとドキュメントの両方で保証する**」ことです。具体的には次を目標とします。

1. **端ケースの網羅的テストシナリオ**  
   - ±180° 近傍の隣接セル・親子関係・children 列挙の連続性。
   - ±85.0511° 近傍でのセル境界誤差（XY 相対誤差の上限）とボクセル生成の整合性。
   - 半球跨ぎバウンディングボックスにおける `bounds` → ボクセル生成 → `getStatistics` 一致性。

2. **統計メトリクスの拡張と可観測性向上**  
   - `Heatbox.getStatistics()` に Spatial ID QA 用のフィールドを追加・整理し、「テストコードから必要な情報が直接取れる状態」にする。
   - ouranos-gex 利用時／フォールバック利用時の違いを統計上で区別し、期待どおりのモードで動いているかを容易に検証できるようにする。

3. **ドキュメントとしての明文化**  
   - Spatial ID 関連ドキュメントに、端ケースでの挙動・制限・推奨設定（例: 適切な zoom 範囲・誤差許容範囲）を追記。
   - 「ouranos-gex がない環境ではフォールバックで動作し、グローバル端ケースでは精度が低下する可能性がある」ことを明確に説明。

### Non-Goals / 非目標

v0.1.19 では、以下はスコープ外（v1.x 以降または別ADRで扱う）とします。

- 新しい Spatial ID モード（例: 4D 時間対応／別仕様の tile-grid）の追加。
- Spatial ID ベースのスタイリングや分類ロジック（色分け・時間アニメーションなど）の追加。
- ouranos-gex-lib-for-javascript の API 仕様変更やフォーク（本ライブラリ側での独自拡張）。
- 他の空間インデックス（OLC / メッシュコード等）との統合 API 設計。

## Decision / 決定事項

v0.1.19 では、Spatial ID tile-grid モードに対する **グローバル QA スイート** を整備し、±180°・高緯度帯・半球跨ぎを含む端ケースを網羅的に検証・ドキュメント化します。実装方針としては次の3つを柱とします。

1. **テストシナリオの体系化**  
   ROADMAP v0.1.19 に列挙されたシナリオをベースに、以下を最小セットとして自動テスト化します。

   - ±180° 付近の隣接セル  
     - +179.9°E ↔ -179.9°W 近傍で `neighbors` / `children` / `parent` の連続性を検証。  
     - 境界跨ぎでセルが重複・欠落しないことを確認（想定される隣接セル集合と比較）。
   - 高緯度帯（±85.0511° 近傍）のタイル形状  
     - Web Mercator の有効範囲上限付近で、タイル境界とボクセル境界の差が仕様許容範囲内（例えば XY 相対誤差 ≤ 10%）に収まることを確認。  
     - ズームを複数レベル（例: 15 / 20 / 25）で変化させ、誤差が継続的に許容範囲内であることを担保。
   - 半球跨ぎ・経度正規化  
     - 東西半球を跨ぐバウンディングボックスで `bounds` → ボクセル生成 → `getStatistics` の一貫性を検証。  
     - 経度正規化（-180°〜+180° vs 0〜360°）の違いが原因でセル欠落や重複が発生しないことを確認。

2. **統計・メトリクスの拡張**  
   Spatial ID モードでの QA を容易にするため、`Heatbox.getStatistics()` に以下のような追加フィールド（またはサブオブジェクト）を導入します。

   - `spatialIdEnabled: boolean`
   - `spatialIdProvider: 'ouranos-gex' | 'fallback' | null`
   - `spatialIdZoom: number | null`
   - `zoomControl: 'auto' | 'manual' | null`
   - （任意）`spatialIdEdgeCases`: テスト用に端ケースでのサマリ値を格納するための内部メトリクス（例：検証対象セル数・誤差の最大値など）

   これらは主に QA・デバッグ用途であり、既存利用者の API ブレークを避けるため **追加フィールドのみ** を前提とします（既存フィールドの意味は変更しない）。

3. **フォールバックと ouranos-gex の扱いの明確化**  
   - ouranos-gex が導入されていない環境では、フォールバック ZFXYConverter を使いつつ、`spatialIdProvider: null` または `'fallback'` として統計に明示する。  
   - ouranos-gex 利用時は `spatialIdProvider: 'ouranos-gex'` を返し、失敗時には WARN ログとフォールバックを行う（クラッシュしない）。  
   - README / Wiki / Spatial-ID-Setup ガイドに、ouranos-gex の有無による挙動差・精度差と端ケースにおける注意点を追記する。

## Architecture / アーキテクチャ

### 対象コンポーネント

```
src/
  core/
    spatial/
      SpatialIdAdapter.js      # Spatial ID tile-grid ロジック（ADR-0013）
      ZFXYConverter.js         # フォールバック変換器
    DataProcessor.js           # Spatial ID モードでのボクセル生成
  Heatbox.js                   # options.spatialId の受け渡し & 統計集計
  utils/
    validation.js              # spatialId オプションのバリデーション/正規化

test/
  core/
    spatial/ZFXYConverter.test.js      # 既存テスト（拡張）
  integration/
    aggregation.test.js                # Spatial ID + aggregation 連携（任意で拡張）
  integration/
    spatial-global-qa.test.js          # NEW: v0.1.19 グローバルQAテスト（このADRの成果物）
```

### 統計拡張: getStatistics()

**既存の前提（簡略化）**：

```javascript
// src/Heatbox.js（イメージ）
getStatistics() {
  return {
    // 既存フィールド
    voxelCount: this._voxelData.size,
    // ...
    spatialIdEnabled: this.options.spatialId?.enabled ?? false,
    spatialIdProvider: this._spatialIdProviderName ?? null,
    spatialIdZoom: this._spatialIdZoom ?? null,
    zoomControl: this.options.spatialId?.zoomControl ?? null
  };
}
```

**v0.1.19 での追加・整理案**：

```javascript
// Spatial ID 関連メタデータを 1 つのサブオブジェクトへまとめるイメージ
getStatistics() {
  const base = { /* 既存の統計 */ };

  const spatialIdOptions = this.options.spatialId || {};

  base.spatialId = {
    enabled: !!spatialIdOptions.enabled,
    provider: this._spatialIdProviderName ?? null,     // 'ouranos-gex' | 'fallback' | null
    zoom: this._spatialIdZoom ?? null,
    zoomControl: spatialIdOptions.zoomControl ?? null,
    // v0.1.19: optional QA metrics
    edgeCaseMetrics: this._spatialIdEdgeCaseMetrics ?? null
  };

  return base;
}
```

ここで `edgeCaseMetrics` は主にテスト用であり、実運用では null のままになることが多い想定です（テスト時に明示的に設定）。

### SpatialIdAdapter / ZFXYConverter の役割

- `SpatialIdAdapter`:
  - ouranos-gex あるいはフォールバック ZFXYConverter をラップし、Heatbox 内部からは共通 IF（`encode`, `bounds`, `center`, `neighbors`, `children`, `parent` など）で使用可能にする。
  - v0.1.19 では主に **neighbors/children/parent/bounds の端ケース挙動** をテストで固定化する。
- `ZFXYConverter`:
  - フォールバック側の Web Mercator ベース実装。
  - ouranos-gex 不在時に使用されるが、高緯度や±180°付近では誤差が大きくなりやすい。
  - v0.1.19 では、「どの程度の誤差までを受容範囲とみなすか」をテストで明示し、ドキュメントにも記載する。

## Detailed Design / 詳細設計

### 1. QA用メトリクス構造

テストで利用するためのメトリクス例（実装は内部フィールド `_spatialIdEdgeCaseMetrics` 等）：

```ts
type SpatialIdEdgeCaseMetrics = {
  datelineNeighborsChecked: number;
  datelineNeighborsMismatched: number;
  polarTilesChecked: number;
  polarMaxRelativeErrorXY: number;
  hemisphereBoundsChecked: number;
  hemisphereBoundsMismatched: number;
};
```

これを `getStatistics().spatialId.edgeCaseMetrics` に公開するか、テストからはインスタンス内部のプライベートフィールドに直接アクセスするかは実装時に検討する（後者の場合は Jest からの直接参照に留める）。

### 2. ±180° 近傍の neighbors/children/parent テスト

**シナリオ例**：

```javascript
// test/integration/spatial-global-qa.test.js（イメージ）

it('neighbors are continuous across the dateline', async () => {
  const zoom = 24;
  const tileLeft = { z: zoom, x: /* ... near dateline W side ... */, y: /* ... */ };
  const tileRight = { z: zoom, x: /* ... near dateline E side ... */, y: /* ... */ };

  const neighborsLeft = adapter.neighbors(tileLeft);
  const neighborsRight = adapter.neighbors(tileRight);

  // 想定される隣接関係が双方向に成立していることを確認
  expect(neighborsLeft).toContainEqual(tileRight);
  expect(neighborsRight).toContainEqual(tileLeft);
});
```

**方針**：
- Ouranos / フォールバックのどちらを使用しても、「隣接セルとして認識されるべきタイルが欠落しない」ことを重視し、必要に応じて Ouranos の仕様に合わせてフォールバック側を調整する。
- neighbors の順序や内部実装詳細には依存せず、集合としての包含関係（`toContainEqual`）で判定する。

### 3. 高緯度帯（±85.0511° 近傍）の誤差評価

**評価指標**：

- ある Spatial ID タイル `id` について：
  - Ouranos/フォールバックが返す `bounds(id)` → `bboxMercator`。
  - 同じ範囲を Heatbox のボクセル生成ロジックに渡して得られるボクセル境界 → `bboxHeatbox`。
- 2つの bbox の XY 幅（東西・南北方向）を比較し、以下のような相対誤差を計算：

```ts
relativeErrorX = |width_heatbox - width_mercator| / width_mercator;
relativeErrorY = |height_heatbox - height_mercator| / height_mercator;
maxRelativeErrorXY = max(relativeErrorX, relativeErrorY);
```

**受け入れ基準案**：

- `maxRelativeErrorXY <= 0.10`（10%）を目安とし、実測結果に応じて微調整。  
- Ouranos 利用環境ではより厳しい閾値（例: 5%）を目指し、フォールバックでは 10% まで許容する、といった差別化も検討。

### 4. 半球跨ぎバウンディングボックスの一貫性

**シナリオ例**：

```javascript
it('bounds → voxelization → statistics is consistent across hemispheres', async () => {
  const viewer = createMockViewer();
  const heatbox = new Heatbox(viewer, {
    spatialId: {
      enabled: true,
      mode: 'tile-grid',
      zoomControl: 'auto'
    },
    voxelSize: 30
  });

  const bounds = {
    west: Cesium.Math.toRadians(170),   // 170E
    east: Cesium.Math.toRadians(-170),  // -170W (wrap)
    south: Cesium.Math.toRadians(35),
    north: Cesium.Math.toRadians(40)
  };

  await heatbox.createFromBounds(bounds);

  const stats = heatbox.getStatistics();
  // stats 内の Spatial ID 関連メトリクスや voxelCount 等を検証
  expect(stats.voxelCount).toBeGreaterThan(0);
  // 必要に応じて、期待されるセル数や分布の範囲を確認
});
```

**ポイント**：

- 経度ラップを伴う `bounds` を与えても、内部的には正しく正規化され、適切なセル/ボクセルが生成されることを確認する。
- Ouranos / フォールバックのどちらでもクラッシュせず、統計情報が取得できる状態を保つ。

## Implementation Plan / 実装計画

ROADMAP v0.1.19 の Target 日付（2025-11-15）を前提に、約 2 週間（10稼働日前後）で以下のフェーズに分割して実施します。

### Phase 0: 準備（Day 0）— 設計とテスト観点の固定

- [ ] ADR-0015（本ドキュメント）の最終化とレビュー完了。
- [ ] ROADMAP v0.1.19 の Acceptance Criteria と本 ADR の受け入れ基準をすり合わせ。
- [ ] ouranos-gex 有無の 2 パターンでテストを実行可能なローカル環境の確認。

### Phase 1: 統計メタデータ拡張（Days 1-2）

- [ ] `Heatbox.getStatistics()` に `spatialId` サブオブジェクト（`enabled`, `provider`, `zoom`, `zoomControl`）を追加。
- [ ] 既存の単体テストを更新し、`spatialId.enabled` などの基本メタ情報が期待通りセットされることを確認。
- [ ] ouranos-gex が無い環境で `provider: null`（または `'fallback'`）になることをテストで固定。

### Phase 2: Edge Case Metrics 導入（Days 3-4）

- [ ] 内部フィールド（例: `_spatialIdEdgeCaseMetrics`）と型（`SpatialIdEdgeCaseMetrics`）を実装。
- [ ] dateline/polar/hemisphere それぞれに対して、検証カウンタ・最大誤差などを格納する仕組みを追加。
- [ ] 必要に応じて `getStatistics().spatialId.edgeCaseMetrics` 経由で外部から参照できるようにする（またはテスト専用に内部参照のみ許可）。

### Phase 3: ±180° 近傍 neighbors/children/parent テスト（Days 5-6）

- [ ] 新規テストファイル `test/integration/spatial-global-qa.test.js` を追加。
- [ ] +179.9°E / -179.9°W 近傍タイルに対する `neighbors` の連続性を検証するテストを実装。
- [ ] `children` / `parent` の関係がラップ境界を跨いでも一貫していることを確認するテストを追加。
- [ ] ouranos-gex 有効時／フォールバック時の両方でテストがグリーンになることを確認（フォールバックは必要に応じて期待値を緩める）。

### Phase 4: 高緯度帯誤差評価（Days 7-8）

- [ ] ±85° 近傍の代表タイルを複数選定（zoom 15 / 20 / 25 など）。
- [ ] `bounds(id)` と Heatbox のボクセル境界から `maxRelativeErrorXY` を計算するヘルパーをテストコード側に追加。
- [ ] Ouranos 利用時とフォールバック利用時での誤差を測定し、Ouranos はより厳しい閾値（例: 5%）、フォールバックは 10% まで許容とするなどのポリシーを決定。
- [ ] 閾値に基づく単体テスト／統合テストを追加し、CI 上でも安定することを確認。

### Phase 5: 半球跨ぎ bounds 一貫性テスト（Day 9）

- [ ] 東経 170°〜西経 -170° のような半球跨ぎ bounds を複数パターン作成。
- [ ] `createFromBounds(bounds)` 実行後に `getStatistics()` を取得し、ボクセル数や範囲が期待値の範囲内に収まっていることを確認するテストを追加。
- [ ] 経度正規化の違い（-180〜+180 / 0〜360）によるセル欠落・重複が発生しないことを検証。

### Phase 6: ドキュメント・サマリ更新（Day 10）

- [ ] `wiki/Spatial-ID-Setup.md` にグローバル端ケースの注意事項と、ouranos/fallback の精度の違いを追記。
- [ ] README の Spatial ID セクションに「Global QA / Limitations」サマリを追加（高緯度・日付変更線付近の挙動）。
- [ ] ROADMAP v0.1.19 のチェックボックス（Acceptance Criteria）をこの ADR に沿って更新。

## Testing Strategy / テスト戦略

### テストレベル

- **Unit Tests**  
  - `SpatialIdAdapter` / `ZFXYConverter` の encode/bounds/center/neighbors/children/parent の振る舞い。
  - `Heatbox.getStatistics()` の `spatialId` メタデータ・QAメトリクスの整合性。

- **Integration Tests**  
  - `test/integration/spatial-global-qa.test.js` で、Viewer+Heatbox の end-to-end フローを通した上で統計値・誤差を検証。
  - ouranos-gex 有無の両モードを可能なら CI かローカルで再現（ouranos 側は開発環境のみでも可）。

- **Performance Considerations**  
  - グローバル QA テストは対象セル数を絞り、実行時間が既存スイートに対して +10〜20% 以内に収まるよう設計。
  - 必要であれば `PERF_TESTS` フラグなどで重いテストを任意実行に切り出し。

### 代表的なテストケース一覧

- Dateline Neighbors:
  - [ ] 左右両側の neighbors に互いが含まれること。
  - [ ] children/parent のチェーンでラップを跨いでもセル欠落がないこと。
- Polar Tiles:
  - [ ] ±85° 近傍の複数タイルで `maxRelativeErrorXY` が閾値以下であること。
- Hemisphere Bounds:
  - [ ] 半球跨ぎ bounds で `voxelCount > 0` かつ期待されるレンジ内に収まること。
- Provider Modes:
  - [ ] ouranos-gex 利用時とフォールバック利用時で、少なくとも「セル欠落・クラッシュがない」ことを確認。

## Consequences / 影響

### Positive / 利点

- Spatial ID tile-grid モードがグローバル座標系でも仕様どおり動作することをテストで保証できる。
- ±180°・高緯度帯・半球跨ぎなどの難しいケースでの挙動が明文化され、外部システムとの連携信頼性が向上する。
- `getStatistics()` に Spatial ID 関連のメタ情報および QA メトリクスが追加されることで、ユーザーや QA が現状を把握しやすくなる。
- ouranos-gex の有無が統計値に反映されるため、「今どちらのモードで動いているか」をコードから確認しやすくなる。

### Negative / トレードオフ

- テストスイートが増えることで CI 時間がわずかに増加する可能性がある（ただし v0.1.19 では主にユニット〜軽量統合テストレベルに留める）。
- `getStatistics()` の返却オブジェクトが肥大化するため、ドキュメント整備とバージョン間互換性の管理コストが増える。
- ouranos-gex とフォールバックの両方を考慮したテスト設計が必要になり、テストの条件分岐やモックの複雑度が若干上がる。

### Compatibility / 互換性

- 既存の Spatial ID オプション構造（ADR-0013 で定義）は変更せず、以下のみを追加する：
  - `Heatbox.getStatistics()` の Spatial ID 関連フィールドと QA メトリクス（サブオブジェクト or フィールド）。
  - グローバルQA用のテスト・ベンチマークコード。
  - ドキュメントの追記（挙動説明と注意点）。
- ouranos-gex がインストールされていない環境でも、フォールバックで処理が継続する既存ポリシーを維持する。

### Open Questions / 残課題

- XY 相対誤差の閾値（10% など）をどこまで厳密に定義するか（実装上の数値誤差・投影の近似を踏まえて要調整）。
- ouranos-gex 利用時とフォールバック利用時で、どこまで受容誤差を差別化するか（ドキュメントに「フォールバック時は高緯度で誤差が増える」旨をどこまで強く書くか）。
- 将来 v1.x 以降で Spatial ID を他の空間インデックス（OLC / メッシュ等）と統合したときに、どの程度まで API を共通化するか。
