e
# ADR-0003: v0.1.6 ハードニングとドキュメント（Lint/Tests/Wiki/凡例サンプル/枠線太さ拡張）

## Status

Proposed - 2025-08-25 (Planned-for: v0.1.6)

## Context

v0.1.5で基本機能（デバッグ境界、知覚均等カラーマップ、発散配色準備、TopN強調）とAPI整合を整備した。
次のv0.1.6は「0.1系の仕上げ」として、品質ゲート（Lint/Tests）、ドキュメント運用（Wiki同期）、
および軽微な新機能（枠線太さ調整の柔軟化）を実施し、安定化フェーズを完了させる。

要件はROADMAPの通り：
- 品質: Lint 0 errors、主要分岐のテスト追補、Examplesの安定化
- ドキュメント: docs/api→Wikiの同期手順/スクリプト、Legend（凡例）のサンプル実装ドキュメント
- 新機能（軽微）: 枠線太さ調整オプションの拡張（全体/TopN/個別）とExamples UI
- 互換性: 破壊的変更なし。軽微なAPI追加のみ。

## Decision

1) 品質ゲート（Lint/Tests/Examples）
- Lint: 現状のESLint指摘（prefer-const、未使用変数等）を解消し、Lintエラー0を受け入れ基準に設定。
  - ルールの緩和は原則行わず、コード修正を優先。
- Tests: VoxelRendererの主要分岐に対してユニットテストを追加。
  - 色補間: `interpolateColor()` の custom/min-max 補間、`colorMap`（viridis/inferno）の補間挙動。
  - 発散配色: `diverging` と `divergingPivot` の影響（pivot対称性、しきい周辺の色遷移）。
  - TopN強調: 非TopNの透過抑制と、TopNでのアウトライン幅の上書き確認。
- Examples: Basic/Advancedを微修正して安定化し、OIT切替例（`viewer.scene.orderIndependentTranslucency`）の案内を追記。

2) ドキュメント運用（Wiki同期/凡例サンプル）
- Wiki同期: docs/api をソース・オブ・トゥルースとし、GitHub Wikiへの完全自動化を実現。
  - Phase 1: `tools/wiki-sync.js` で docs/api → wiki/ へ自動変換（JSDoc HTML → Markdown変換）
  - Phase 2: 既存 `tools/wiki/publish-wiki.sh` を `npm run wiki:publish` として統合
  - Phase 3: GitHub Actions workflow `.github/workflows/wiki-sync.yml` で自動化
    - トリガー: main ブランチへの docs/ 変更push、または手動dispatch
    - 権限: `GITHUB_TOKEN` または専用 Personal Access Token (wiki write権限)
    - 安全性: wiki変更の差分確認、rollback手順の整備
  - フォールバック: 手動実行用 npm script `npm run wiki:publish` を維持
  - 手順書: `docs/wiki-maintenance.md` で自動化設定と緊急時手順を明文化。
- 凡例サンプル: Legend（凡例）は v0.1.x ではコアに含めず、外部サンプル実装として提示。
  - ライブラリ外（Examples/Docs）に「凡例オーバレイの参考実装」を掲載し、0.2系の分類スキーム導入までAPIの安定性を優先。

3) 枠線太さ調整の柔軟化（後方互換を維持）
- 既存の仕様維持: 
  - 既定の枠線太さ: `options.outlineWidth: number`（全体既定）
  - TopNの上書き: `options.highlightStyle.outlineWidth: number`（TopN時のみ）
- 追加オプション（非破壊）:
  - `options.outlineWidthResolver?: (params) => number`
    - params: `{ voxel: { x, y, z, count }, isTopN: boolean, normalizedDensity: number }`
    - 戻り値: 当該ボクセルの `outlineWidth`（>= 0）
    - パフォーマンス考慮: 大量ボクセル処理時の関数コール頻度に注意。キャッシュ化検討。
  - 解決順: `outlineWidthResolver` があればその戻り値を採用 → なければ `isTopN ? highlightStyle.outlineWidth : outlineWidth` を使用。
- **枠線重なり対策**（太い枠線使用時の視認性確保）:
  - 問題: 隣接ボクセルで太い枠線（4px+）が重なり、視認性低下・描画ノイズが発生。
  - 対策1: ボクセル寸法微調整 - `options.voxelGap?: number` （デフォルト0）でボクセル間に微小ギャップ（1-2px相当）を設ける。
  - 対策2: 枠線透明度制御 - `options.outlineOpacity?: number` （デフォルト1.0）で重なり部分の視覚ノイズ軽減。
  - 対策3: 適応的太さ制限 - `outlineWidthResolver` 内で隣接ボクセル密度を考慮した動的太さ調整（密集時は細く、疎な時は太く）。
  - 実装優先度: v0.1.6ではvoxelGap基本対応、透明度制御はUI追加。**適応的制御はv0.1.7で実装予定**。
- Examples: UIで `outlineWidth`（全体）と TopN用 `highlightStyle.outlineWidth` を調整可能に。
  - さらに任意の「密度に応じて太くする」スイッチ例を用意（`outlineWidthResolver` サンプル）。
  - 枠線重なり確認用の「密集配置テスト」モードを追加（小範囲に多数ボクセル配置）。

4) 受け入れ基準（Definition of Done）
- Lint 0 errors（ESLint）
- テスト緑（前述の分岐を最低限カバー）+ テストカバレッジ主要モジュール80%以上維持
- README / API.md / Wiki / Examples が v0.1.6 内容に同期
- 枠線太さ調整機能（Resolver／TopN上書き／全体既定）の動作確認
- **枠線重なり対策**: `voxelGap` と `outlineOpacity` の動作確認、密集配置での視認性テスト合格
- パフォーマンス: 1000+ ボクセル描画で `outlineWidthResolver` 使用時の影響が許容範囲内（<10%増加）
- Wiki自動化: GitHub Actions workflow の動作確認と手動フォールバック機能の検証
- ドキュメント: Wiki更新手順書の作成、自動化設定手順、rollback手順の整備

## Consequences

Positive
- 品質の可視化: Lint/Tests を基準化することで品質の下限を保証。
- 利用性向上: Wiki自動同期と凡例サンプルにより導入容易性が向上。
- 表現力の拡張: 枠線太さをTopN/個別レベルで制御可能になり、視認性を用途に合わせて最適化可能。
- 運用効率化: Wiki自動化により開発者の手動作業負担を削減、ドキュメント更新の信頼性向上。

Negative / Risks
- オプション複雑性: `outlineWidthResolver` 追加によりAPIの分岐が増える（既定は従来どおりで影響軽微）。
- 枠線重なり対策の複雑性: `voxelGap` 導入によりボクセル配置計算の追加処理、視覚的整合性の検証コスト増加。
- CesiumJS制約: Entity Box outline の内側オフセット直接制御が困難な場合の代替実装検討が必要。
- テストメンテ: カラーマップ・発散配色・枠線重なり仕様変更時にテストの追随コストが発生。
- 自動化複雑性: GitHub Actions workflow の設定・保守、権限管理の複雑性増加。
- Wiki rollback: 自動化によるWiki更新ミス時の復旧手順が必要。

## Rollout & Migration

- 非破壊変更のため移行コストはゼロ。既存コードはそのまま動作。
- `outlineWidthResolver` を使わない場合、現行の `outlineWidth` と `highlightStyle.outlineWidth` の挙動は不変。
- ドキュメント（API.md / README / Wiki）を v0.1.6 に同期し、ExamplesにUIを追加。

## Alternatives Considered

- `outline` 設定をオブジェクトに一本化（`outline: { default, topN, perVoxel }`）
  - メリット: 関連設定の集約
  - デメリット: 既存の `outlineWidth`/`highlightStyle` との二重表現・混乱を招くため採用せず。
- TopNだけでなく「しきい値別の多段太さ」を標準化
  - 段階導入の観点から今回は関数Resolverで柔軟性を担保し、プリセットは将来版で再検討。
- パフォーマンス重視のプリセット方式（`outlineWidthPreset: 'density-based'|'topn-only'|'uniform'`）
  - メリット: 関数呼び出しのオーバーヘッド削減、予測しやすいパフォーマンス
  - デメリット: 柔軟性の制限。関数Resolverで十分な性能が得られる場合は過剰最適化。v0.1.6では見送り、使用実績を経て必要なら v0.1.7+ で追加検討。
- Wiki自動化の代替アプローチ:
  - 手動同期維持（現状）: メリット=シンプル、デメリット=運用負荷・ヒューマンエラー
  - Webhook連動: メリット=リアルタイム同期、デメリット=外部サービス依存・複雑性
  - 定期実行（cron/scheduled）: メリット=安定性、デメリット=遅延・リソース消費
  - GitHub Actions選択理由: 既存CI/CD基盤利用、権限管理統合、手動フォールバック併用で安全性確保。
- 枠線重なり対策の代替手法:
  - ボクセル寸法縮小（voxelGap）: 採用。シンプルで効果的、既存描画ロジックへの影響最小。
  - 枠線描画順序制御: 検討したが、CesiumJS Entity描画順序の制御が複雑で v0.1.6 では見送り。
  - 二重枠線（内側・外側）: 視覚的魅力はあるが、パフォーマンス・複雑性コストが高く却下。
  - 枠線色のグラデーション: 重なり部分の視覚ノイズ軽減効果は限定的、実装コスト高で却下。

## References

- ROADMAP.md: v0.1.6 — ハードニングとドキュメント（短期・仕上げ）
- CHANGELOG.md: v0.1.6（予定）項目

