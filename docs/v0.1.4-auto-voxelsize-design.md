# v0.1.4 ボクセルサイズ自動決定機能 - 設計仕様書

## 概要

エンティティ数・分布範囲に基づいて最適な `voxelSize` を自動計算する機能を追加し、初心者ユーザーの使いやすさとパフォーマンス安定性を向上させる。

## 設計方針

### 1. オプション設計

#### Option A: Boolean型（推奨）
```typescript
interface HeatboxOptions {
  autoVoxelSize?: boolean;    // デフォルト: false（既存互換性維持）
  voxelSize?: number;         // 手動指定時は autoVoxelSize を無効化
}
```

#### Option B: 3モード型（高度）  
```typescript
interface HeatboxOptions {
  autoVoxelSize?: 'off' | 'warn' | 'adjust';  // デフォルト: 'off'
  voxelSize?: number;
}
```

**採用**: **Option A (Boolean型)** - シンプルで理解しやすい

### 2. 動作仕様

#### 優先度
1. **手動指定優先**: `voxelSize` が明示されている場合は自動調整無効
2. **自動調整**: `autoVoxelSize: true` かつ `voxelSize` 未指定の場合のみ実行
3. **既存互換**: デフォルト `autoVoxelSize: false` で既存コード影響なし

#### アルゴリズム
```javascript
// 1. 境界計算とデータ密度分析
const bounds = CoordinateTransformer.calculateBounds(entities);
const dataRange = calculateDataRange(bounds);
const estimatedDensity = entities.length / dataRange;

// 2. 初期サイズ推定
let voxelSize = estimateInitialVoxelSize(dataRange, entities.length);

// 3. 総ボクセル数チェック・調整
const grid = VoxelGrid.createGrid(bounds, voxelSize);
const validation = validateVoxelCount(grid.totalVoxels, voxelSize);

if (!validation.valid && validation.recommendedSize) {
  voxelSize = validation.recommendedSize;
  Logger.info(`Auto-adjusted voxelSize to ${voxelSize}m (${grid.totalVoxels} → ${newGrid.totalVoxels} voxels)`);
}
```

#### 調整ロジック詳細
1. **データ範囲解析**: X/Y/Z軸の物理的範囲（メートル）を計算
2. **密度推定**: エンティティ密度 = エンティティ数 / データ範囲体積
3. **初期サイズ**: 密度に応じた適切な初期ボクセルサイズを推定
4. **制限チェック**: `PERFORMANCE_LIMITS.maxVoxels` (50000) との照合
5. **調整適用**: 制限超過時に `validateVoxelCount` の推奨サイズを適用。描画寸法は `grid.cellSizeX/Y/Z` を使用し、隣接ボクセルの重なりを回避。

### 3. データ記録

#### 統計情報追加
```typescript
interface HeatboxStatistics {
  // 既存フィールド...
  autoAdjusted?: boolean;           // 自動調整が実行されたか
  originalVoxelSize?: number;       // 調整前のサイズ
  finalVoxelSize?: number;          // 最終的に使用されたサイズ
  adjustmentReason?: string;        // 調整理由
}
```

#### デバッグ情報追加
```javascript
getDebugInfo(): {
  // 既存フィールド...
  autoVoxelSizeInfo?: {
    enabled: boolean;
    originalSize?: number;
    finalSize: number;
    adjusted: boolean;
    reason?: string;
    dataRange: { x: number, y: number, z: number };
    estimatedDensity: number;
  }
}
```

### 4. 実装箇所

#### 主要変更ファイル
1. **src/utils/constants.js**: `DEFAULT_OPTIONS` に `autoVoxelSize: false` 追加
2. **src/Heatbox.js**: コンストラクタで自動調整ロジック実行
3. **src/utils/validation.js**: `estimateInitialVoxelSize()` 関数追加
4. **src/core/DataProcessor.js**: 統計情報に調整情報を記録
5. **tools/build-types.js**: 型定義更新

#### 新規ユーティリティ関数
```javascript
// src/utils/validation.js に追加
export function estimateInitialVoxelSize(bounds, entityCount) {
  // データ範囲ベースの初期推定
}

export function calculateDataRange(bounds) {
  // X/Y/Z軸の物理的範囲計算
}
```

## 実装フェーズ

### Phase 1: コア機能実装
1. オプション追加 (`autoVoxelSize: boolean`)
2. 自動調整アルゴリズム実装
3. 統計・デバッグ情報記録
4. ログ出力

### Phase 2: UI・例更新  
1. 基本例に「自動 vs 手動」比較UI追加
2. 高度な例でのデモンストレーション
3. README/Wiki更新

### Phase 3: テスト・文書化
1. 単体テスト追加
2. JSDoc更新・HTML再生成
3. 型定義更新

## 使用例

### 基本的な使用
```javascript
// 自動サイズ決定（新規ユーザー推奨）
const heatbox = new Heatbox(viewer, {
  autoVoxelSize: true  // データに応じて最適サイズを自動決定
});

// 手動指定（既存ユーザー・細かい制御が必要な場合）
const heatbox = new Heatbox(viewer, {
  voxelSize: 25  // 明示指定時は自動調整無効
});
```

### 調整情報の確認
```javascript
const stats = heatbox.getStatistics();
if (stats.autoAdjusted) {
  console.log(`Voxel size auto-adjusted: ${stats.originalVoxelSize}m → ${stats.finalVoxelSize}m`);
  console.log(`Reason: ${stats.adjustmentReason}`);
}

const debug = heatbox.getDebugInfo();
console.log('Auto voxel size info:', debug.autoVoxelSizeInfo);
```

## エラーハンドリング

### 自動調整失敗時
- フォールバック: `DEFAULT_OPTIONS.voxelSize` (20m) を使用
- ログ: `Logger.warn` で失敗理由を出力
- 統計: `autoAdjusted: false` で記録

### 互換性保証
- 既存コード影響なし（デフォルト `autoVoxelSize: false`）
- 既存の `voxelSize` オプション優先動作維持
- APIシグネチャ変更なし

## テストケース

### 正常系
1. 小規模データ (100 entities) → 適切な細かいサイズ
2. 中規模データ (5000 entities) → バランス取れたサイズ  
3. 大規模データ (50000 entities) → 制限内での粗いサイズ

### 異常系
1. エンティティ数 0 → デフォルトサイズフォールバック
2. 境界計算失敗 → デフォルトサイズフォールバック
3. 推奨サイズ計算失敗 → 警告ログ + デフォルトサイズ

### 互換性
1. `autoVoxelSize` 未指定 → 既存動作維持
2. `voxelSize` 明示指定 → 自動調整無効確認
3. 両オプション指定 → `voxelSize` 優先確認
